{
    "version": "https://jsonfeed.org/version/1",
    "title": "M1N's Blog • All posts by \"应急响应\" category",
    "description": "M1N的博客",
    "home_page_url": "http://blog.m1n.me",
    "items": [
        {
            "id": "http://blog.m1n.me/2022/01/04/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E4%BA%8B%E4%BB%B6%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/",
            "url": "http://blog.m1n.me/2022/01/04/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E4%BA%8B%E4%BB%B6%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/",
            "title": "记一次简单的蠕虫病毒事件应急响应",
            "date_published": "2022-01-04T08:16:05.000Z",
            "content_html": "<h2 id=\"背景描述\"><a class=\"markdownIt-Anchor\" href=\"#背景描述\">#</a> 背景描述</h2>\n<p>某日接到某省政务外网安全监管平台通报，某单位的一个 IP 发生 Parite 蠕虫病毒活动事件，其对政务外网内其他地市主机发起 SMB 扫描攻击。</p>\n<span id=\"more\"></span>\n<h2 id=\"事件分析处置\"><a class=\"markdownIt-Anchor\" href=\"#事件分析处置\">#</a> 事件分析处置</h2>\n<ol>\n<li>\n<p>与客户沟通，被通报的 IP 为政务网的出口 IP，不属于某一台服务器</p>\n</li>\n<li>\n<p>网络环境中具有上网行为管理系统，通过排查筛选，定位到一共有四台主机向其他主机的 445 端口发送大量请求</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620353.png\" alt=\"image-20211116165756380\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>与客户沟通了解到对应的四台主机为个人 PC，不是服务器，远程登录到其中的一台主机上</p>\n</li>\n<li>\n<p>上机发现客户对接人员很贴心的帮我们用杀毒软件进行了排查</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620817.png\" alt=\"image-20211116165949834\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>可以看到排查到的风险文件为 C:\\Windows\\svchost.exe，参考文章 https://xz.aliyun.com/t/8095#toc-4 可以知道，通常在攻击者使用创建服务来实现权限维持的时候，可以把恶意进程隐藏在 svchost 进程中。</p>\n</li>\n<li>\n<p>通过工具检查端口使用情况，发现进程 ID 为 2824 的程序向外部主机 445 端口发起大量 TCP 请求</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620314.png\" alt=\"image-20211116170723354\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>通过任务管理器查找对于的进程，发现其服务名为 mssecsvc2.0</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620578.png\" alt=\"image-20211116171005724\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>定位到恶意文件为 C:\\Windows\\mssecsvc.exe 文件</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620248.png\" alt=\"image-20211116171100384\" class=\"lazyload\"></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620281.png\" alt=\"image-20211116171221677\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>通过搜索引擎收集此恶意文件的相关信息，得到其相关描述：</p>\n<p>mssecsvc.exe 文件为通过利用永恒之蓝漏洞的勒索病毒，原病毒文件 mssecsvc.exe 会释放并执行 tasksche.exe 文件，然后检查 kill switch 域名。之后它会创建 mssecsvc2.0 服务。该服务会使用与初次执行不同的入口点执行 mssecsvc.exe 文件。第二次执行会检查被感染电脑的 IP 地址，并尝试联接到相同子网内每个 IP 地址的 TCP 445 端口。当恶意软件成功攻击并联接到一台电脑时，将会建立联接并传输数据，不断进行扩散攻击。</p>\n</li>\n<li>\n<p>通过排查发现 C:\\Windows 目录下的确存在 tasksche.exe 文件</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620466.png\" alt=\"image-20211116172028785\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>通过排查如系统账号、启动项、计划任务、服务等攻击者常用于权限维持手段的敏感配置，发现 mssecsvc.exe 运行于 svchost.exe 进程下，这与步骤 4 中的杀毒软件排查相互印证，而运行于 svchost.exe 的行为常见于攻击者通过注册系统服务来实现自启动恶意文件的目的</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620529.png\" alt=\"image-20211116172256162\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>排查系统的自启动服务项，发现确实存在自启动 mssecsvc2.0 服务的服务项</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620000.png\" alt=\"image-20211116172406701\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>结合搜索引擎中关于 mssecsvc.exe 病毒的描述是通过永恒之蓝漏洞进行传播，利用 360NSA 武器库免疫工具对主机是否存在永恒之蓝漏洞进行排查，发现系统存在多个包括永恒之蓝在内的主机漏洞</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041620955.png\" alt=\"image-20211116172422895\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>排查主机端口开启状态，发现该主机的 445 端口对外开放</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621402.png\" alt=\"image-20211116172445687\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>通过对主机上的病毒样本进行采样，上传至分析系统进行检测，其主要的恶意行为如下：</p>\n<p>（1）通过创建服务实现自启动，这与步骤 7、8 所排查到的行为相互印证</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621665.png\" alt=\"image-20211116172532390\" class=\"lazyload\"></p>\n<p>（2）<a href=\"http://xn--www-633e.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com\">向 www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com</a>、104.17.244.81 发送请求</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621059.png\" alt=\"image-20211116172614229\" class=\"lazyload\"></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621514.png\" alt=\"image-20211116172619205\" class=\"lazyload\"></p>\n<p>通过威胁情报可以确定对应 IP、域名为常见勒索病毒对应的恶意域名</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621899.png\" alt=\"image-20211116172640677\" class=\"lazyload\"></p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041700279.png\" alt=\"image-20211116172648753\" class=\"lazyload\"></p>\n</li>\n<li>\n<p>继续对剩余的三台主机进行排查，发现大致情况都一致</p>\n</li>\n</ol>\n<h2 id=\"排查结论\"><a class=\"markdownIt-Anchor\" href=\"#排查结论\">#</a> 排查结论</h2>\n<p>经过详细检测分析，判断该单位出口 IP 为 xxx.xxx.xxx.xxx 的内网网段中，有四台主机感染了 Wannacry 系列勒索病毒家族的蠕虫病毒。</p>\n<p>此病毒通过利用永恒之蓝漏洞进行感染传播，当某台主机存在永恒之蓝漏洞被攻击感染上病毒后，将变成新的攻击机，对内外网中的其他主机进行攻击达到扩散传播的目的。此行为被政务外网安全监管平台捕获，触发报警。</p>\n<h2 id=\"修复建议\"><a class=\"markdownIt-Anchor\" href=\"#修复建议\">#</a> 修复建议</h2>\n<p>1、 通过安装系统补丁（补丁地址见第 7 点），或 360NSA 武器免疫工具（下载地址：<a href=\"http://dl.360safe.com/nsa/nsatool.exe%EF%BC%89%E4%BF%AE%E5%A4%8D%E2%80%9C%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E2%80%9D%E6%BC%8F%E6%B4%9E%E3%80%82\">http://dl.360safe.com/nsa/nsatool.exe）修复 “永恒之蓝” 漏洞。</a></p>\n<p>2、 添加入站规则，建议关闭除业务外不必要的端口 445、135、137、138、139 端口</p>\n<p>3、 断网并对系统全部磁盘进行病毒木马扫描，以清除蠕虫病毒，并观察一段时间，若又发现蠕虫病毒需保存备份重要文件并重装系统。</p>\n<p>4、 开启服务的日志记录功能，及时安装并更新相关补丁。</p>\n<p>5、 对主机系统安装杀毒软件。</p>\n<p>6、 定期查看系统安全日志，并且使用杀毒软件定期对系统进行体检。</p>\n<p>7、 下载补丁地址 <a href=\"http://www.catalog.update.microsoft.com/search.aspx?q=%E8%A1%A5%E4%B8%81%E7%BC%96%E5%8F%B7\">http://www.catalog.update.microsoft.com/search.aspx?q = 补丁编号</a> （根据自己的系统版本在下图中查找补丁编号）</p>\n<p><img data-fancybox=\"gallery\" data-sizes=\"auto\" data-src=\"https://m1n-1258939911.cos.ap-nanjing.myqcloud.com/BlogImages/Contents/202201041621577.png\" alt=\"image-20211116172902197\" class=\"lazyload\"></p>\n<h2 id=\"reference\"><a class=\"markdownIt-Anchor\" href=\"#reference\">#</a> Reference</h2>\n<p><a href=\"https://xz.aliyun.com/t/8095#toc-4\">https://xz.aliyun.com/t/8095#toc-4</a></p>\n",
            "tags": []
        }
    ]
}